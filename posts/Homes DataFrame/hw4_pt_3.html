<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Ann Brennan - HW 4 - Homes DataFrame</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Ann Brennan</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-final-projects" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Final Projects</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-final-projects">    
        <li>
    <a class="dropdown-item" href="../../project.html" rel="" target="">
 <span class="dropdown-text">DANL200</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../project-210.html" rel="" target="">
 <span class="dropdown-text">DANL210</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../blog-listing.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../danl_proj_nba.html" rel="" target="">
 <span class="menu-text">Project</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-python-data-analysis" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Python Data Analysis</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-python-data-analysis">    
        <li>
    <a class="dropdown-item" href="../../pandas_basics.html" rel="" target="">
 <span class="dropdown-text">Pandas Basics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../seaborn_basics.html" rel="" target="">
 <span class="dropdown-text">Seaborn Basics</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools ms-auto">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">HW 4 - Homes DataFrame</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>In this post, we will be considering the <code>homes</code> DataFrame from the 2004 American Housing Survey. This contains data on home values, demographics, schools, income, finance, mortgages, sales, neighborhood characteristics, noise, smells, state geography, and urban classification. We will be applying Linear Regression and Logistic Regression models in order to analyze how different factors impact or predict home value.</p>
<section id="loading-packages-and-settings" class="level2">
<h2 class="anchored" data-anchor-id="loading-packages-and-settings">Loading Packages and Settings</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> data_table</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>data_table.enable_dataframe_formatter()</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate  <span class="co"># for table summary</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.stats <span class="im">as</span> stats</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm  <span class="co"># for lowess smoothing</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> precision_recall_curve</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_curve</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> rand, col, <span class="bu">pow</span>, mean, avg, when, log, sqrt, exp</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> VectorAssembler</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> LinearRegression, GeneralizedLinearRegression</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> BinaryClassificationEvaluator</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>spark <span class="op">=</span> SparkSession.builder.master(<span class="st">"local[*]"</span>).getOrCreate()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="udfs" class="level2">
<h2 class="anchored" data-anchor-id="udfs">UDFs</h2>
<p>We will be using a variety of User Defined Functions (UDFs) in order to perform functions necessary for our Logistic Regression Models. We will define our UDFs before we begin.</p>
<section id="marginal_effects" class="level3">
<h3 class="anchored" data-anchor-id="marginal_effects">marginal_effects</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> marginal_effects(model, means):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute marginal effects for all predictors in a PySpark GeneralizedLinearRegression model (logit)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">    and return a formatted table with statistical significance and standard errors.</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">        model: Fitted GeneralizedLinearRegression model (with binomial family and logit link).</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">        means: List of mean values for the predictor variables.</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">        - A formatted string containing the marginal effects table.</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">        - A Pandas DataFrame with marginal effects, standard errors, confidence intervals, and significance stars.</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> assembler_predictors  <span class="co"># Use the global assembler_predictors list</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract model coefficients, standard errors, and intercept</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    coeffs <span class="op">=</span> np.array(model.coefficients)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    std_errors <span class="op">=</span> np.array(model.summary.coefficientStandardErrors)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    intercept <span class="op">=</span> model.intercept</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute linear combination of means and coefficients (XB)</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    XB <span class="op">=</span> np.dot(means, coeffs) <span class="op">+</span> intercept</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute derivative of logistic function (G'(XB))</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    G_prime_XB <span class="op">=</span> np.exp(XB) <span class="op">/</span> ((<span class="dv">1</span> <span class="op">+</span> np.exp(XB)) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Helper: significance stars.</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> significance_stars(p):</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> p <span class="op">&lt;</span> <span class="fl">0.01</span>:</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"***"</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> p <span class="op">&lt;</span> <span class="fl">0.05</span>:</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"**"</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> p <span class="op">&lt;</span> <span class="fl">0.1</span>:</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"*"</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create lists to store results</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    df_results <span class="op">=</span> []  <span class="co"># For Pandas DataFrame</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, predictor <span class="kw">in</span> <span class="bu">enumerate</span>(assembler_predictors):</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute marginal effect</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>        marginal_effect <span class="op">=</span> G_prime_XB <span class="op">*</span> coeffs[i]</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute standard error of the marginal effect</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>        std_error <span class="op">=</span> G_prime_XB <span class="op">*</span> std_errors[i]</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute z-score and p-value</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>        z_score <span class="op">=</span> marginal_effect <span class="op">/</span> std_error <span class="cf">if</span> std_error <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>        p_value <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> norm.cdf(<span class="bu">abs</span>(z_score))) <span class="cf">if</span> <span class="kw">not</span> np.isnan(z_score) <span class="cf">else</span> np.nan</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute confidence interval (95%)</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>        ci_lower <span class="op">=</span> marginal_effect <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> std_error</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>        ci_upper <span class="op">=</span> marginal_effect <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> std_error</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Append results for table formatting</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>        results.append([</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>            predictor,</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span>marginal_effect<span class="sc">: .4f}</span><span class="ss">"</span>,</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>            significance_stars(p_value),</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span>std_error<span class="sc">: .4f}</span><span class="ss">"</span>,</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span>ci_lower<span class="sc">: .4f}</span><span class="ss">"</span>,</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span>ci_upper<span class="sc">: .4f}</span><span class="ss">"</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Append results for Pandas DataFrame</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>        df_results.append({</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Variable"</span>: predictor,</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Marginal Effect"</span>: marginal_effect,</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Significance"</span>: significance_stars(p_value),</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Std. Error"</span>: std_error,</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>            <span class="st">"95% CI Lower"</span>: ci_lower,</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>            <span class="st">"95% CI Upper"</span>: ci_upper</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert results to formatted table</span></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    table_str <span class="op">=</span> tabulate(results, headers<span class="op">=</span>[<span class="st">"Variable"</span>, <span class="st">"Marginal Effect"</span>, <span class="st">"Significance"</span>, <span class="st">"Std. Error"</span>, <span class="st">"95% CI Lower"</span>, <span class="st">"95% CI Upper"</span>],</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>                         tablefmt<span class="op">=</span><span class="st">"pretty"</span>, colalign<span class="op">=</span>(<span class="st">"left"</span>, <span class="st">"decimal"</span>, <span class="st">"left"</span>, <span class="st">"decimal"</span>, <span class="st">"decimal"</span>, <span class="st">"decimal"</span>))</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert results to Pandas DataFrame</span></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>    df_results <span class="op">=</span> pd.DataFrame(df_results)</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table_str, df_results</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a><span class="co"># means = [0.5, 30]  # Mean values for x1 and x2</span></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a><span class="co"># assembler_predictors = ['x1', 'x2']  # Define globally before calling the function</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a><span class="co"># table_output, df_output = marginal_effects(fitted_model, means)</span></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a><span class="co"># print(table_output)</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a><span class="co"># display(df_output)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="regression_table" class="level3">
<h3 class="anchored" data-anchor-id="regression_table">regression_table</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> regression_table(model, assembler):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Creates a formatted regression table from a fitted LinearRegression model and its VectorAssembler.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    If the model’s labelCol (retrieved using getLabelCol()) starts with "log", an extra column showing np.exp(coeff)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">    is added immediately after the beta estimate column for predictor rows. Additionally, np.exp() of the 95% CI</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Lower and Upper bounds is also added unless the predictor's name includes "log_". The Intercept row does not</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">    include exponentiated values.</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">    When labelCol starts with "log", the columns are ordered as:</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">        y: [label] | Beta | Exp(Beta) | Sig. | Std. Error | p-value | 95% CI Lower | 95% CI Upper | Exp(95% CI Lower) | Exp(95% CI Upper)</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Otherwise, the columns are:</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">        y: [label] | Beta | Sig. | Std. Error | p-value | 95% CI Lower | 95% CI Upper</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">        model: A fitted LinearRegression model (with a .summary attribute and a labelCol).</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">        assembler: The VectorAssembler used to assemble the features for the model.</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">        A formatted string containing the regression table.</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine if we should display exponential values for coefficients.</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    is_log <span class="op">=</span> model.getLabelCol().lower().startswith(<span class="st">"log"</span>)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract coefficients and standard errors as NumPy arrays.</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    coeffs <span class="op">=</span> model.coefficients.toArray()</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    std_errors_all <span class="op">=</span> np.array(model.summary.coefficientStandardErrors)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the intercept's standard error is included (one extra element).</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(std_errors_all) <span class="op">==</span> <span class="bu">len</span>(coeffs) <span class="op">+</span> <span class="dv">1</span>:</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>        intercept_se <span class="op">=</span> std_errors_all[<span class="dv">0</span>]</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        std_errors <span class="op">=</span> std_errors_all[<span class="dv">1</span>:]</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        intercept_se <span class="op">=</span> <span class="va">None</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        std_errors <span class="op">=</span> std_errors_all</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use provided tValues and pValues.</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> model.summary.numInstances <span class="op">-</span> <span class="bu">len</span>(coeffs) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    t_critical <span class="op">=</span> stats.t.ppf(<span class="fl">0.975</span>, df)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    p_values <span class="op">=</span> model.summary.pValues</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Helper: significance stars.</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> significance_stars(p):</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> p <span class="op">&lt;</span> <span class="fl">0.01</span>:</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"***"</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> p <span class="op">&lt;</span> <span class="fl">0.05</span>:</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"**"</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> p <span class="op">&lt;</span> <span class="fl">0.1</span>:</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"*"</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build table rows for each feature.</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> []</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, beta, se, p <span class="kw">in</span> <span class="bu">zip</span>(assembler.getInputCols(), coeffs, std_errors, p_values):</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        ci_lower <span class="op">=</span> beta <span class="op">-</span> t_critical <span class="op">*</span> se</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>        ci_upper <span class="op">=</span> beta <span class="op">+</span> t_critical <span class="op">*</span> se</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if predictor contains "log_" to determine if exponentiation should be applied</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>        apply_exp <span class="op">=</span> is_log <span class="kw">and</span> <span class="st">"log_"</span> <span class="kw">not</span> <span class="kw">in</span> feature.lower()</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>        exp_beta <span class="op">=</span> np.exp(beta) <span class="cf">if</span> apply_exp <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>        exp_ci_lower <span class="op">=</span> np.exp(ci_lower) <span class="cf">if</span> apply_exp <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>        exp_ci_upper <span class="op">=</span> np.exp(ci_upper) <span class="cf">if</span> apply_exp <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> is_log:</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>            table.append([</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>                feature,            <span class="co"># Predictor name</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>                beta,               <span class="co"># Beta estimate</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>                exp_beta,           <span class="co"># Exponential of beta (or blank)</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>                significance_stars(p),</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>                se,</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>                p,</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>                ci_lower,</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>                ci_upper,</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>                exp_ci_lower,       <span class="co"># Exponential of 95% CI lower bound</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>                exp_ci_upper        <span class="co"># Exponential of 95% CI upper bound</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>            ])</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>            table.append([</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>                feature,</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>                beta,</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>                significance_stars(p),</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>                se,</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>                p,</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>                ci_lower,</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>                ci_upper</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>            ])</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process intercept.</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> intercept_se <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>        intercept_p <span class="op">=</span> model.summary.pValues[<span class="dv">0</span>] <span class="cf">if</span> model.summary.pValues <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>        intercept_sig <span class="op">=</span> significance_stars(intercept_p)</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>        ci_intercept_lower <span class="op">=</span> model.intercept <span class="op">-</span> t_critical <span class="op">*</span> intercept_se</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>        ci_intercept_upper <span class="op">=</span> model.intercept <span class="op">+</span> t_critical <span class="op">*</span> intercept_se</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>        intercept_sig <span class="op">=</span> <span class="st">""</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>        ci_intercept_lower <span class="op">=</span> <span class="st">""</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>        ci_intercept_upper <span class="op">=</span> <span class="st">""</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>        intercept_se <span class="op">=</span> <span class="st">""</span></span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_log:</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>        table.append([</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Intercept"</span>,</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>            model.intercept,</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>            <span class="st">""</span>,                    <span class="co"># Removed np.exp(model.intercept)</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>            intercept_sig,</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>            intercept_se,</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>            <span class="st">""</span>,</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>            ci_intercept_lower,</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>            <span class="st">""</span>,</span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>            ci_intercept_upper,</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>            <span class="st">""</span></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>        table.append([</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Intercept"</span>,</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>            model.intercept,</span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>            intercept_sig,</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>            intercept_se,</span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>            <span class="st">""</span>,</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>            ci_intercept_lower,</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>            ci_intercept_upper</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append overall model metrics.</span></span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_log:</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>        table.append([<span class="st">"Observations"</span>, model.summary.numInstances, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>])</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>        table.append([<span class="st">"R²"</span>, model.summary.r2, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>])</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>        table.append([<span class="st">"RMSE"</span>, model.summary.rootMeanSquaredError, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>])</span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>        table.append([<span class="st">"Observations"</span>, model.summary.numInstances, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>])</span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>        table.append([<span class="st">"R²"</span>, model.summary.r2, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>])</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>        table.append([<span class="st">"RMSE"</span>, model.summary.rootMeanSquaredError, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>])</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format the table rows.</span></span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>    formatted_table <span class="op">=</span> []</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> table:</span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>        formatted_row <span class="op">=</span> []</span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, item <span class="kw">in</span> <span class="bu">enumerate</span>(row):</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Format Observations as integer with commas.</span></span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> row[<span class="dv">0</span>] <span class="op">==</span> <span class="st">"Observations"</span> <span class="kw">and</span> i <span class="op">==</span> <span class="dv">1</span> <span class="kw">and</span> <span class="bu">isinstance</span>(item, (<span class="bu">int</span>, <span class="bu">float</span>, np.floating)) <span class="kw">and</span> item <span class="op">!=</span> <span class="st">""</span>:</span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>                formatted_row.append(<span class="ss">f"</span><span class="sc">{</span><span class="bu">int</span>(item)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="bu">isinstance</span>(item, (<span class="bu">int</span>, <span class="bu">float</span>, np.floating)) <span class="kw">and</span> item <span class="op">!=</span> <span class="st">""</span>:</span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> is_log:</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># When is_log, the columns are:</span></span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># 0: Metric, 1: Beta, 2: Exp(Beta), 3: Sig, 4: Std. Error, 5: p-value,</span></span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># 6: 95% CI Lower, 7: 95% CI Upper, 8: Exp(95% CI Lower), 9: Exp(95% CI Upper).</span></span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> i <span class="kw">in</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>]:</span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>                        formatted_row.append(<span class="ss">f"</span><span class="sc">{</span>item<span class="sc">:,</span><span class="fl">.3</span><span class="er">f</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> i <span class="op">==</span> <span class="dv">5</span>:</span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>                        formatted_row.append(<span class="ss">f"</span><span class="sc">{</span>item<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>                        formatted_row.append(<span class="ss">f"</span><span class="sc">{</span>item<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># When not is_log, the columns are:</span></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># 0: Metric, 1: Beta, 2: Sig, 3: Std. Error, 4: p-value, 5: 95% CI Lower, 6: 95% CI Upper.</span></span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> i <span class="kw">in</span> [<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">6</span>]:</span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>                        formatted_row.append(<span class="ss">f"</span><span class="sc">{</span>item<span class="sc">:,</span><span class="fl">.3</span><span class="er">f</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> i <span class="op">==</span> <span class="dv">4</span>:</span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>                        formatted_row.append(<span class="ss">f"</span><span class="sc">{</span>item<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a>                        formatted_row.append(<span class="ss">f"</span><span class="sc">{</span>item<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>                formatted_row.append(item)</span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>        formatted_table.append(formatted_row)</span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set header and column alignment based on whether label starts with "log"</span></span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_log:</span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>        headers <span class="op">=</span> [</span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"y: </span><span class="sc">{</span>model<span class="sc">.</span>getLabelCol()<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Beta"</span>, <span class="st">"Exp(Beta)"</span>, <span class="st">"Sig."</span>, <span class="st">"Std. Error"</span>, <span class="st">"p-value"</span>,</span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a>            <span class="st">"95% CI Lower"</span>, <span class="st">"95% CI Upper"</span>, <span class="st">"Exp(95% CI Lower)"</span>, <span class="st">"Exp(95% CI Upper)"</span></span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a>        colalign <span class="op">=</span> (<span class="st">"left"</span>, <span class="st">"right"</span>, <span class="st">"right"</span>, <span class="st">"center"</span>, <span class="st">"right"</span>, <span class="st">"right"</span>, <span class="st">"right"</span>, <span class="st">"right"</span>, <span class="st">"right"</span>, <span class="st">"right"</span>)</span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a>        headers <span class="op">=</span> [<span class="ss">f"y: </span><span class="sc">{</span>model<span class="sc">.</span>getLabelCol()<span class="sc">}</span><span class="ss">"</span>, <span class="st">"Beta"</span>, <span class="st">"Sig."</span>, <span class="st">"Std. Error"</span>, <span class="st">"p-value"</span>, <span class="st">"95% CI Lower"</span>, <span class="st">"95% CI Upper"</span>]</span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a>        colalign <span class="op">=</span> (<span class="st">"left"</span>, <span class="st">"right"</span>, <span class="st">"center"</span>, <span class="st">"right"</span>, <span class="st">"right"</span>, <span class="st">"right"</span>, <span class="st">"right"</span>)</span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>    table_str <span class="op">=</span> tabulate(</span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>        formatted_table,</span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>        headers<span class="op">=</span>headers,</span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a>        tablefmt<span class="op">=</span><span class="st">"pretty"</span>,</span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a>        colalign<span class="op">=</span>colalign</span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Insert a dashed line after the Intercept row.</span></span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> table_str.split(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a>    dash_line <span class="op">=</span> <span class="st">'-'</span> <span class="op">*</span> <span class="bu">len</span>(lines[<span class="dv">0</span>])</span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, line <span class="kw">in</span> <span class="bu">enumerate</span>(lines):</span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"Intercept"</span> <span class="kw">in</span> line <span class="kw">and</span> <span class="kw">not</span> line.strip().startswith(<span class="st">'+'</span>):</span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a>            lines.insert(i<span class="op">+</span><span class="dv">1</span>, dash_line)</span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(lines)</span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a><span class="co"># print(regression_table(model_1, assembler_1))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="add_dummy_variables" class="level3">
<h3 class="anchored" data-anchor-id="add_dummy_variables">add_dummy_variables</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_dummy_variables(var_name, reference_level, category_order<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Creates dummy variables for the specified column in the global DataFrames dtrain and dtest.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Allows manual setting of category order.</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">        var_name (str): The name of the categorical column (e.g., "borough_name").</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">        reference_level (int): Index of the category to be used as the reference (dummy omitted).</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">        category_order (list, optional): List of categories in the desired order. If None, categories are sorted.</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">        dummy_cols (list): List of dummy column names excluding the reference category.</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">        ref_category (str): The category chosen as the reference.</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> dtrain, dtest</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get distinct categories from the training set.</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    categories <span class="op">=</span> dtrain.select(var_name).distinct().rdd.flatMap(<span class="kw">lambda</span> x: x).collect()</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert booleans to strings if present.</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    categories <span class="op">=</span> [<span class="bu">str</span>(c) <span class="cf">if</span> <span class="bu">isinstance</span>(c, <span class="bu">bool</span>) <span class="cf">else</span> c <span class="cf">for</span> c <span class="kw">in</span> categories]</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use manual category order if provided; otherwise, sort categories.</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> category_order:</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure all categories are present in the user-defined order</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        missing <span class="op">=</span> <span class="bu">set</span>(categories) <span class="op">-</span> <span class="bu">set</span>(category_order)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> missing:</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"These categories are missing from your custom order: </span><span class="sc">{</span>missing<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        categories <span class="op">=</span> category_order</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        categories <span class="op">=</span> <span class="bu">sorted</span>(categories)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validate reference_level</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> reference_level <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">or</span> reference_level <span class="op">&gt;=</span> <span class="bu">len</span>(categories):</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"reference_level must be between 0 and </span><span class="sc">{</span><span class="bu">len</span>(categories) <span class="op">-</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the reference category</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    ref_category <span class="op">=</span> categories[reference_level]</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Reference category (dummy omitted):"</span>, ref_category)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create dummy variables for all categories</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cat <span class="kw">in</span> categories:</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        dummy_col_name <span class="op">=</span> var_name <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> <span class="bu">str</span>(cat).replace(<span class="st">" "</span>, <span class="st">"_"</span>)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        dtrain <span class="op">=</span> dtrain.withColumn(dummy_col_name, when(col(var_name) <span class="op">==</span> cat, <span class="dv">1</span>).otherwise(<span class="dv">0</span>))</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        dtest <span class="op">=</span> dtest.withColumn(dummy_col_name, when(col(var_name) <span class="op">==</span> cat, <span class="dv">1</span>).otherwise(<span class="dv">0</span>))</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of dummy columns, excluding the reference category</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    dummy_cols <span class="op">=</span> [var_name <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> <span class="bu">str</span>(cat).replace(<span class="st">" "</span>, <span class="st">"_"</span>) <span class="cf">for</span> cat <span class="kw">in</span> categories <span class="cf">if</span> cat <span class="op">!=</span> ref_category]</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dummy_cols, ref_category</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage without category_order:</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a><span class="co"># dummy_cols_year, ref_category_year = add_dummy_variables('year', 0)</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage with category_order:</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="co"># custom_order_wkday = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday']</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a><span class="co"># dummy_cols_wkday, ref_category_wkday = add_dummy_variables('wkday', reference_level=0, category_order = custom_order_wkday)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="add_interaction_terms" class="level3">
<h3 class="anchored" data-anchor-id="add_interaction_terms">add_interaction_terms</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_interaction_terms(var_list1, var_list2, var_list3<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Creates interaction term columns in the global DataFrames dtrain and dtest.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    For two sets of variable names (which may represent categorical (dummy) or continuous variables),</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">    this function creates two-way interactions by multiplying each variable in var_list1 with each</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">    variable in var_list2.</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Optionally, if a third list of variable names (var_list3) is provided, the function also creates</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">    three-way interactions among each variable in var_list1, each variable in var_list2, and each variable</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">    in var_list3.</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">        var_list1 (list): List of column names for the first set of variables.</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">        var_list2 (list): List of column names for the second set of variables.</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">        var_list3 (list, optional): List of column names for the third set of variables for three-way interactions.</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co">        A flat list of new interaction column names.</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> dtrain, dtest</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    interaction_cols <span class="op">=</span> []</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create two-way interactions between var_list1 and var_list2.</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var1 <span class="kw">in</span> var_list1:</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var2 <span class="kw">in</span> var_list2:</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>            col_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>var1<span class="sc">}</span><span class="ss">_*_</span><span class="sc">{</span>var2<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>            dtrain <span class="op">=</span> dtrain.withColumn(col_name, col(var1).cast(<span class="st">"double"</span>) <span class="op">*</span> col(var2).cast(<span class="st">"double"</span>))</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>            dtest <span class="op">=</span> dtest.withColumn(col_name, col(var1).cast(<span class="st">"double"</span>) <span class="op">*</span> col(var2).cast(<span class="st">"double"</span>))</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>            interaction_cols.append(col_name)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create two-way interactions between var_list1 and var_list3.</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var_list3 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> var1 <span class="kw">in</span> var_list1:</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> var3 <span class="kw">in</span> var_list3:</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>              col_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>var1<span class="sc">}</span><span class="ss">_*_</span><span class="sc">{</span>var3<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>              dtrain <span class="op">=</span> dtrain.withColumn(col_name, col(var1).cast(<span class="st">"double"</span>) <span class="op">*</span> col(var3).cast(<span class="st">"double"</span>))</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>              dtest <span class="op">=</span> dtest.withColumn(col_name, col(var1).cast(<span class="st">"double"</span>) <span class="op">*</span> col(var3).cast(<span class="st">"double"</span>))</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>              interaction_cols.append(col_name)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create two-way interactions between var_list2 and var_list3.</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var_list3 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> var2 <span class="kw">in</span> var_list2:</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> var3 <span class="kw">in</span> var_list3:</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>              col_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>var2<span class="sc">}</span><span class="ss">_*_</span><span class="sc">{</span>var3<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>              dtrain <span class="op">=</span> dtrain.withColumn(col_name, col(var2).cast(<span class="st">"double"</span>) <span class="op">*</span> col(var3).cast(<span class="st">"double"</span>))</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>              dtest <span class="op">=</span> dtest.withColumn(col_name, col(var2).cast(<span class="st">"double"</span>) <span class="op">*</span> col(var3).cast(<span class="st">"double"</span>))</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>              interaction_cols.append(col_name)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If a third list is provided, create three-way interactions.</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var_list3 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var1 <span class="kw">in</span> var_list1:</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> var2 <span class="kw">in</span> var_list2:</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> var3 <span class="kw">in</span> var_list3:</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>                    col_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>var1<span class="sc">}</span><span class="ss">_*_</span><span class="sc">{</span>var2<span class="sc">}</span><span class="ss">_*_</span><span class="sc">{</span>var3<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>                    dtrain <span class="op">=</span> dtrain.withColumn(col_name, col(var1).cast(<span class="st">"double"</span>) <span class="op">*</span> col(var2).cast(<span class="st">"double"</span>) <span class="op">*</span> col(var3).cast(<span class="st">"double"</span>))</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>                    dtest <span class="op">=</span> dtest.withColumn(col_name, col(var1).cast(<span class="st">"double"</span>) <span class="op">*</span> col(var2).cast(<span class="st">"double"</span>) <span class="op">*</span> col(var3).cast(<span class="st">"double"</span>))</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>                    interaction_cols.append(col_name)</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> interaction_cols</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a> <span class="co"># Example</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a> <span class="co"># interaction_cols_brand_price = add_interaction_terms(dummy_cols_brand, ['log_price'])</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a> <span class="co"># interaction_cols_brand_ad_price = add_interaction_terms(dummy_cols_brand, dummy_cols_ad, ['log_price'])</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="compare_reg_models" class="level3">
<h3 class="anchored" data-anchor-id="compare_reg_models">compare_reg_models</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_reg_models(models, assemblers, names<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Produces a single formatted table comparing multiple regression models.</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">    For each predictor (the union across models, ordered by first appearance), the table shows</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">    the beta estimate (with significance stars) from each model (blank if not used).</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">    For a predictor, if a model's outcome (model.getLabelCol()) starts with "log", the cell displays</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">    both the beta and its exponential (separated by " / "), except when the predictor's name includes "log_".</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">    (The intercept row does not display exp(.))</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Additional rows for Intercept, Observations, R², and RMSE are appended.</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">    The header's first column is labeled "Predictor", and subsequent columns are</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">    "y: [outcome] ([name])" for each model.</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">    The table is produced in grid format (with vertical lines). A dashed line (using '-' characters)</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co">    is inserted at the top, immediately after the header, and at the bottom.</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Additionally, immediately after the Intercept row, the border line is replaced with one using '='</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co">    (to appear as, for example, "+==============================================+==========================+...").</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co">        models (list): List of fitted LinearRegression models.</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co">        assemblers (list): List of corresponding VectorAssembler objects.</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="co">        names (list, optional): List of model names; defaults to "Model 1", "Model 2", etc.</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co">        A formatted string containing the combined regression table.</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Default model names.</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> names <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        names <span class="op">=</span> [<span class="ss">f"Model </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(models))]</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each model, get outcome and determine if that model is log-transformed.</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    outcomes <span class="op">=</span> [m.getLabelCol() <span class="cf">for</span> m <span class="kw">in</span> models]</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    is_log_flags <span class="op">=</span> [out.lower().startswith(<span class="st">"log"</span>) <span class="cf">for</span> out <span class="kw">in</span> outcomes]</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build an ordered union of predictors based on first appearance.</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    ordered_predictors <span class="op">=</span> []</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> assembler <span class="kw">in</span> assemblers:</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> feat <span class="kw">in</span> assembler.getInputCols():</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> feat <span class="kw">not</span> <span class="kw">in</span> ordered_predictors:</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>                ordered_predictors.append(feat)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Helper for significance stars.</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> significance_stars(p):</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> p <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> p <span class="op">&lt;</span> <span class="fl">0.01</span>:</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"***"</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> p <span class="op">&lt;</span> <span class="fl">0.05</span>:</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"**"</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> p <span class="op">&lt;</span> <span class="fl">0.1</span>:</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"*"</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build rows for each predictor.</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    rows <span class="op">=</span> []</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feat <span class="kw">in</span> ordered_predictors:</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>        row <span class="op">=</span> [feat]</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> m, a, is_log <span class="kw">in</span> <span class="bu">zip</span>(models, assemblers, is_log_flags):</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>            feats_model <span class="op">=</span> a.getInputCols()</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> feat <span class="kw">in</span> feats_model:</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>                idx <span class="op">=</span> feats_model.index(feat)</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>                beta <span class="op">=</span> m.coefficients.toArray()[idx]</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>                p_val <span class="op">=</span> m.summary.pValues[idx] <span class="cf">if</span> m.summary.pValues <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>                stars <span class="op">=</span> significance_stars(p_val)</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>                cell <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>beta<span class="sc">:.3f}{</span>stars<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Only add exp(beta) if model is log and predictor name does NOT include "log_"</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> is_log <span class="kw">and</span> (<span class="st">"log_"</span> <span class="kw">not</span> <span class="kw">in</span> feat.lower()):</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>                    cell <span class="op">+=</span> <span class="ss">f" / </span><span class="sc">{</span>np<span class="sc">.</span>exp(beta)<span class="sc">:,</span><span class="fl">.3</span><span class="er">f</span><span class="sc">}</span><span class="ss">"</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>                row.append(cell)</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>                row.append(<span class="st">""</span>)</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>        rows.append(row)</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build intercept row (do NOT compute exp(intercept)).</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>    intercept_row <span class="op">=</span> [<span class="st">"Intercept"</span>]</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> m <span class="kw">in</span> models:</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>        std_all <span class="op">=</span> np.array(m.summary.coefficientStandardErrors)</span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>        coeffs <span class="op">=</span> m.coefficients.toArray()</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(std_all) <span class="op">==</span> <span class="bu">len</span>(coeffs) <span class="op">+</span> <span class="dv">1</span>:</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>            intercept_p <span class="op">=</span> m.summary.pValues[<span class="dv">0</span>] <span class="cf">if</span> m.summary.pValues <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>            intercept_p <span class="op">=</span> <span class="va">None</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>        sig <span class="op">=</span> significance_stars(intercept_p)</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>        cell <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>m<span class="sc">.</span>intercept<span class="sc">:.3f}{</span>sig<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>        intercept_row.append(cell)</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>    rows.append(intercept_row)</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add Observations row.</span></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>    obs_row <span class="op">=</span> [<span class="st">"Observations"</span>]</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> m <span class="kw">in</span> models:</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>        obs <span class="op">=</span> m.summary.numInstances</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>        obs_row.append(<span class="ss">f"</span><span class="sc">{</span><span class="bu">int</span>(obs)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>    rows.append(obs_row)</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add R² row.</span></span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>    r2_row <span class="op">=</span> [<span class="st">"R²"</span>]</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> m <span class="kw">in</span> models:</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>        r2_row.append(<span class="ss">f"</span><span class="sc">{</span>m<span class="sc">.</span>summary<span class="sc">.</span>r2<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>    rows.append(r2_row)</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add RMSE row.</span></span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>    rmse_row <span class="op">=</span> [<span class="st">"RMSE"</span>]</span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> m <span class="kw">in</span> models:</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>        rmse_row.append(<span class="ss">f"</span><span class="sc">{</span>m<span class="sc">.</span>summary<span class="sc">.</span>rootMeanSquaredError<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>    rows.append(rmse_row)</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build header: first column "Predictor", then for each model: "y: [outcome] ([name])"</span></span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>    header <span class="op">=</span> [<span class="st">"Predictor"</span>]</span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> out, name <span class="kw">in</span> <span class="bu">zip</span>(outcomes, names):</span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>        header.append(<span class="ss">f"y: </span><span class="sc">{</span>out<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create table string using grid format.</span></span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>    table_str <span class="op">=</span> tabulate(rows, headers<span class="op">=</span>header, tablefmt<span class="op">=</span><span class="st">"grid"</span>, colalign<span class="op">=</span>(<span class="st">"left"</span>,) <span class="op">+</span> (<span class="st">"right"</span>,)<span class="op">*</span><span class="bu">len</span>(models))</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split into lines.</span></span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> table_str.split(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a dashed line spanning the full width.</span></span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>    full_width <span class="op">=</span> <span class="bu">len</span>(lines[<span class="dv">0</span>])</span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>    dash_line <span class="op">=</span> <span class="st">'-'</span> <span class="op">*</span> full_width</span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create an equals line by replacing '-' with '='.</span></span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>    eq_line <span class="op">=</span> dash_line.replace(<span class="st">'-'</span>, <span class="st">'='</span>)</span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Insert a dashed line after the header row.</span></span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> table_str.split(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># In grid format, header and separator are usually the first two lines.</span></span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>    lines.insert(<span class="dv">2</span>, dash_line)</span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Insert an equals line after the Intercept row.</span></span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, line <span class="kw">in</span> <span class="bu">enumerate</span>(lines):</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> line.startswith(<span class="st">"|"</span>) <span class="kw">and</span> <span class="st">"Intercept"</span> <span class="kw">in</span> line:</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i<span class="op">+</span><span class="dv">1</span> <span class="op">&lt;</span> <span class="bu">len</span>(lines):</span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>                lines[i<span class="op">+</span><span class="dv">1</span>] <span class="op">=</span> eq_line</span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add dashed lines at the very top and bottom.</span></span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>    final_table <span class="op">=</span> dash_line <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(lines) <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> dash_line</span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> final_table</span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a><span class="co"># print(compare_reg_models([model_1, model_2, model_3],</span></span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a><span class="co">#                          [assembler_1, assembler_2, assembler_3],</span></span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a><span class="co">#                          ["Model 1", "Model 2", "Model 3"]))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="compare_rmse" class="level3">
<h3 class="anchored" data-anchor-id="compare_rmse">compare_rmse</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_rmse(test_dfs, label_col, pred_col<span class="op">=</span><span class="st">"prediction"</span>, names<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes and compares RMSE values for a list of test DataFrames.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">    For each DataFrame in test_dfs, this function calculates the RMSE between the actual outcome</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">    (given by label_col) and the predicted value (given by pred_col, default "prediction"). It then</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">    produces a formatted table where the first column header is empty and the first row's first cell is</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">    "RMSE", with each model's RMSE in its own column.</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">        test_dfs (list): List of test DataFrames.</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">        label_col (str): The name of the outcome column.</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">        pred_col (str, optional): The name of the prediction column (default "prediction").</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">        names (list, optional): List of model names corresponding to the test DataFrames.</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">                                Defaults to "Model 1", "Model 2", etc.</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co">        A formatted string containing a table that compares RMSE values for each test DataFrame,</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="co">        with one model per column.</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set default model names if none provided.</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> names <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        names <span class="op">=</span> [<span class="ss">f"Model </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(test_dfs))]</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    rmse_values <span class="op">=</span> []</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> df <span class="kw">in</span> test_dfs:</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a column for squared error.</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.withColumn(<span class="st">"error_sq"</span>, <span class="bu">pow</span>(col(label_col) <span class="op">-</span> col(pred_col), <span class="dv">2</span>))</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate RMSE: square root of the mean squared error.</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        rmse <span class="op">=</span> df.agg(sqrt(avg(<span class="st">"error_sq"</span>)).alias(<span class="st">"rmse"</span>)).collect()[<span class="dv">0</span>][<span class="st">"rmse"</span>]</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        rmse_values.append(rmse)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build a single row table: first cell "RMSE", then one cell per model with the RMSE value.</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> [<span class="st">"RMSE"</span>] <span class="op">+</span> [<span class="ss">f"</span><span class="sc">{</span>rmse<span class="sc">:.3f}</span><span class="ss">"</span> <span class="cf">for</span> rmse <span class="kw">in</span> rmse_values]</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build header: first column header is empty, then model names.</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    header <span class="op">=</span> [<span class="st">""</span>] <span class="op">+</span> names</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    table_str <span class="op">=</span> tabulate([row], headers<span class="op">=</span>header, tablefmt<span class="op">=</span><span class="st">"grid"</span>, colalign<span class="op">=</span>(<span class="st">"left"</span>,) <span class="op">+</span> (<span class="st">"right"</span>,)<span class="op">*</span><span class="bu">len</span>(names))</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table_str</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="co"># print(compare_rmse([dtest_1, dtest_2, dtest_3], "log_sales", names=["Model 1", "Model 2", "Model 3"]))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="residual_plot" class="level3">
<h3 class="anchored" data-anchor-id="residual_plot">residual_plot</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> residual_plot(df, label_col, model_name):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Generates a residual plot for a given test dataframe.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">        df (DataFrame): Spark DataFrame containing the test set with predictions.</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">        label_col (str): The column name of the actual outcome variable.</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">        title (str): The title for the residual plot.</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">        None (displays the plot)</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to Pandas DataFrame</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    df_pd <span class="op">=</span> df.select([<span class="st">"prediction"</span>, label_col]).toPandas()</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    df_pd[<span class="st">"residual"</span>] <span class="op">=</span> df_pd[label_col] <span class="op">-</span> df_pd[<span class="st">"prediction"</span>]</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scatter plot of residuals vs. predicted values</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    plt.scatter(df_pd[<span class="st">"prediction"</span>], df_pd[<span class="st">"residual"</span>], alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"darkgray"</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use LOWESS smoothing for trend line</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    smoothed <span class="op">=</span> sm.nonparametric.lowess(df_pd[<span class="st">"residual"</span>], df_pd[<span class="st">"prediction"</span>])</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    plt.plot(smoothed[:, <span class="dv">0</span>], smoothed[:, <span class="dv">1</span>], color<span class="op">=</span><span class="st">"darkblue"</span>)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add reference line at y=0</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    plt.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Labels and title (model_name)</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Predicted Values"</span>)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Residuals"</span>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    model_name <span class="op">=</span> <span class="st">"Residual Plot for "</span> <span class="op">+</span> model_name</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    plt.title(model_name)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show plot</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="co"># residual_plot(dtest_1, "log_sales", "Model 1")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="loading-dataframe---homes" class="level2">
<h2 class="anchored" data-anchor-id="loading-dataframe---homes">Loading DataFrame - Homes</h2>
<div class="cell" data-outputid="92bc6181-4dc5-4e37-a38d-bd28799073a3">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>homes <span class="op">=</span> pd.read_csv(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">'https://bcdanl.github.io/data/american_housing_survey.csv'</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>homes.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Warning: Total number of columns (29) exceeds max_columns (20). Falling back to pandas display.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="89">

  <div id="df-e039fded-8a71-4289-a6e4-e9b400014ab3" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LPRICE</th>
<th data-quarto-table-cell-role="th">VALUE</th>
<th data-quarto-table-cell-role="th">STATE</th>
<th data-quarto-table-cell-role="th">METRO</th>
<th data-quarto-table-cell-role="th">ZINC2</th>
<th data-quarto-table-cell-role="th">HHGRAD</th>
<th data-quarto-table-cell-role="th">BATHS</th>
<th data-quarto-table-cell-role="th">BEDRMS</th>
<th data-quarto-table-cell-role="th">PER</th>
<th data-quarto-table-cell-role="th">ZADULT</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">EABAN</th>
<th data-quarto-table-cell-role="th">HOWH</th>
<th data-quarto-table-cell-role="th">HOWN</th>
<th data-quarto-table-cell-role="th">ODORA</th>
<th data-quarto-table-cell-role="th">STRNA</th>
<th data-quarto-table-cell-role="th">AMMORT</th>
<th data-quarto-table-cell-role="th">INTW</th>
<th data-quarto-table-cell-role="th">MATBUY</th>
<th data-quarto-table-cell-role="th">DWNPAY</th>
<th data-quarto-table-cell-role="th">FRSTHO</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>85000</td>
<td>150000</td>
<td>GA</td>
<td>rural</td>
<td>15600</td>
<td>No HS</td>
<td>2</td>
<td>3</td>
<td>1</td>
<td>1</td>
<td>...</td>
<td>0</td>
<td>good</td>
<td>good</td>
<td>0</td>
<td>0</td>
<td>50000</td>
<td>9</td>
<td>1</td>
<td>other</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>76500</td>
<td>130000</td>
<td>GA</td>
<td>rural</td>
<td>61001</td>
<td>HS Grad</td>
<td>2</td>
<td>3</td>
<td>5</td>
<td>2</td>
<td>...</td>
<td>0</td>
<td>good</td>
<td>bad</td>
<td>0</td>
<td>1</td>
<td>70000</td>
<td>5</td>
<td>1</td>
<td>other</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>93900</td>
<td>135000</td>
<td>GA</td>
<td>rural</td>
<td>38700</td>
<td>HS Grad</td>
<td>2</td>
<td>3</td>
<td>4</td>
<td>2</td>
<td>...</td>
<td>0</td>
<td>good</td>
<td>good</td>
<td>0</td>
<td>0</td>
<td>117000</td>
<td>6</td>
<td>0</td>
<td>other</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>100000</td>
<td>140000</td>
<td>GA</td>
<td>rural</td>
<td>80000</td>
<td>No HS</td>
<td>3</td>
<td>4</td>
<td>2</td>
<td>2</td>
<td>...</td>
<td>0</td>
<td>good</td>
<td>good</td>
<td>0</td>
<td>1</td>
<td>100000</td>
<td>7</td>
<td>1</td>
<td>prev home</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>100000</td>
<td>135000</td>
<td>GA</td>
<td>rural</td>
<td>61000</td>
<td>HS Grad</td>
<td>2</td>
<td>3</td>
<td>2</td>
<td>2</td>
<td>...</td>
<td>0</td>
<td>good</td>
<td>good</td>
<td>0</td>
<td>0</td>
<td>100000</td>
<td>4</td>
<td>1</td>
<td>other</td>
<td>1</td>
</tr>
</tbody>
</table>


<p>5 rows × 29 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-e039fded-8a71-4289-a6e4-e9b400014ab3')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-e039fded-8a71-4289-a6e4-e9b400014ab3 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-e039fded-8a71-4289-a6e4-e9b400014ab3');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-3607f3ca-655e-4060-9c99-c8550e48d497">
  <button class="colab-df-quickchart" onclick="quickchart('df-3607f3ca-655e-4060-9c99-c8550e48d497')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-3607f3ca-655e-4060-9c99-c8550e48d497 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
</section>
<section id="exploratory-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory Data Analysis</h2>
<p>Before applying our Logistic Regression Model, let’s explore some of the relationships in this DataFrame.</p>
<section id="home-value-vs-household-income" class="level3">
<h3 class="anchored" data-anchor-id="home-value-vs-household-income">Home Value vs Household Income</h3>
<div class="cell" data-outputid="b68a0865-825a-468e-b34f-511b563dec30">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>homes[<span class="st">'log_income'</span>] <span class="op">=</span> np.log(homes[<span class="st">'ZINC2'</span>])</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>homes[<span class="st">'log_value'</span>] <span class="op">=</span> np.log(homes[<span class="st">'VALUE'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.11/dist-packages/pandas/core/arraylike.py:399: RuntimeWarning: divide by zero encountered in log
  result = getattr(ufunc, method)(*inputs, **kwargs)
/usr/local/lib/python3.11/dist-packages/pandas/core/arraylike.py:399: RuntimeWarning: invalid value encountered in log
  result = getattr(ufunc, method)(*inputs, **kwargs)</code></pre>
</div>
</div>
<div class="cell" data-outputid="c826d695-f9b7-4c40-c96a-ca9ddaec9dd0">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(x<span class="op">=</span>homes[<span class="st">'log_income'</span>], y<span class="op">=</span>homes[<span class="st">'log_value'</span>], alpha<span class="op">=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">
<pre><code>&lt;Axes: xlabel='log_income', ylabel='log_value'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="hw4_pt_3_files/figure-html/cell-12-output-2.png" class="img-fluid"></p>
</div>
</div>
<p><strong>This scatterplot shows the relationship between the log of household income and the log of home values. I took the log of each variable to reduce skewness and make it easier to see patterns in the scatterplot. Here, we can see that a higher household income is generally associated with a higher house value.</strong></p>
</section>
<section id="number-of-bedrooms-vs-house-value" class="level3">
<h3 class="anchored" data-anchor-id="number-of-bedrooms-vs-house-value">Number of Bedrooms vs House Value</h3>
<div class="cell" data-outputid="c4acf6c4-ab38-4b41-8587-a5ebf1507acc">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span>homes[<span class="st">'BEDRMS'</span>], y<span class="op">=</span>homes[<span class="st">'VALUE'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>&lt;Axes: xlabel='BEDRMS', ylabel='VALUE'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="hw4_pt_3_files/figure-html/cell-13-output-2.png" class="img-fluid"></p>
</div>
</div>
<p><strong>These boxplots show the distribution of house values for different numbers of bedrooms. Houses with 6 and 8 bedrooms have the widest range in house value, whereas houses with only 1 bedroom have the least amount of variation in value. Houses with more bedrooms may have greater variation in value because they could range from older, lower value properties to newer, high value estates. Overall, as more bedrooms are added, home values tend to increase but with greater variability.</strong></p>
</section>
<section id="junk-in-the-streets-vs-house-value" class="level3">
<h3 class="anchored" data-anchor-id="junk-in-the-streets-vs-house-value">Junk in the Streets vs House Value</h3>
<div class="cell" data-outputid="8841521a-09ef-43ed-9806-ac692c46d649">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span>homes[<span class="st">'EJUNK'</span>], y<span class="op">=</span>homes[<span class="st">'VALUE'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>&lt;Axes: xlabel='EJUNK', ylabel='VALUE'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="hw4_pt_3_files/figure-html/cell-14-output-2.png" class="img-fluid"></p>
</div>
</div>
<p><strong>These boxplots show the distribution of house values for the amount of junk in the streets. Houses without junk in the streets have a slightly wider range of values than houses with junk in the streets. Additionally, houses with junk in the streets tend to be slightly less expensive than houses without junk in the streets.</strong></p>
</section>
</section>
<section id="linear-regression" class="level2">
<h2 class="anchored" data-anchor-id="linear-regression">Linear Regression</h2>
<p>Next, we will build a Linear Regression Model to predict home values based on several variables and analyze the accurary of its predictions. For the predictor variables, we will use all of the variables in the DataFrame, excluding home value, the amount of the first mortgage payment, and the purchase price of the unit and land. The outcome variable will be the log value of the home.</p>
<section id="log-transformation" class="level3">
<h3 class="anchored" data-anchor-id="log-transformation">Log Transformation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> spark.createDataFrame(homes)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> (</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    df</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    .withColumn(<span class="st">"LOG_VALUE"</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                log(df[<span class="st">'VALUE'</span>]) )</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="training-test-split" class="level3">
<h3 class="anchored" data-anchor-id="training-test-split">Training-Test Split</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>dtrain, dtest <span class="op">=</span> df.randomSplit([<span class="fl">0.6</span>, <span class="fl">0.4</span>], seed <span class="op">=</span> <span class="dv">1234</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="assigning-dummy-variables" class="level3">
<h3 class="anchored" data-anchor-id="assigning-dummy-variables">Assigning Dummy Variables</h3>
<p>Before we begin training our models, we must add dummy variables for our categorical variables. To do this, we will apply our UDF for adding dummy variables. All observations must be numerical in order to train the Linear Regression Model.</p>
<div class="cell" data-outputid="f6cedfa9-91b9-4af5-8235-133f11a2e871">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>dummy_cols_STATE, ref_category_STATE <span class="op">=</span> add_dummy_variables(<span class="st">'STATE'</span>, <span class="dv">0</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>dummy_cols_METRO, ref_category_METRO <span class="op">=</span> add_dummy_variables(<span class="st">'METRO'</span>, <span class="dv">0</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>dummy_cols_HHGRAD, ref_category_HHGRAD <span class="op">=</span> add_dummy_variables(<span class="st">'HHGRAD'</span>, <span class="dv">1</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>dummy_cols_HOWH, ref_category_HOWH <span class="op">=</span> add_dummy_variables(<span class="st">'HOWH'</span>, <span class="dv">0</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>dummy_cols_HOWN, ref_category_HOWN <span class="op">=</span> add_dummy_variables(<span class="st">'HOWN'</span>, <span class="dv">0</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>dummy_cols_DWNPAY, ref_category_DWNPAY <span class="op">=</span> add_dummy_variables(<span class="st">'DWNPAY'</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reference category (dummy omitted): CA
Reference category (dummy omitted): rural
Reference category (dummy omitted): Bach
Reference category (dummy omitted): bad
Reference category (dummy omitted): bad
Reference category (dummy omitted): other</code></pre>
</div>
</div>
</section>
<section id="linear-regression-model-1" class="level3">
<h3 class="anchored" data-anchor-id="linear-regression-model-1">Linear Regression (Model 1)</h3>
<div class="cell" data-outputid="233c294f-18a1-40da-c4ff-bdde4d5ac5e6">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># assembling predictors</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>conti_cols <span class="op">=</span> [<span class="st">'ZINC2'</span>, <span class="st">'BATHS'</span>, <span class="st">'BEDRMS'</span>, <span class="st">'PER'</span>, <span class="st">'ZADULT'</span>, <span class="st">'NUNITS'</span>, <span class="st">'EAPTBL'</span>, <span class="st">'ECOM1'</span>, <span class="st">'ECOM2'</span>, <span class="st">'EGREEN'</span>, <span class="st">'EJUNK'</span>, <span class="st">'ELOW1'</span>,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>              <span class="st">'ESFD'</span>, <span class="st">'ETRANS'</span>, <span class="st">'EABAN'</span>, <span class="st">'ODORA'</span>, <span class="st">'STRNA'</span>, <span class="st">'INTW'</span>, <span class="st">'MATBUY'</span>, <span class="st">'FRSTHO'</span>]</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>dummy_cols <span class="op">=</span> dummy_cols_STATE <span class="op">+</span> dummy_cols_METRO <span class="op">+</span> dummy_cols_HHGRAD <span class="op">+</span> dummy_cols_HOWH <span class="op">+</span> dummy_cols_HOWN <span class="op">+</span> dummy_cols_DWNPAY</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>assembler_predictors_1 <span class="op">=</span> (</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    conti_cols <span class="op">+</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    dummy_cols</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>assembler_1 <span class="op">=</span> VectorAssembler(</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    inputCols <span class="op">=</span> assembler_predictors_1,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    outputCol <span class="op">=</span> <span class="st">"predictors"</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>dtrain_1 <span class="op">=</span> assembler_1.transform(dtrain)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>dtest_1  <span class="op">=</span> assembler_1.transform(dtest)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="co"># training model</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>model_1 <span class="op">=</span> (</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    LinearRegression(featuresCol<span class="op">=</span><span class="st">"predictors"</span>,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>                     labelCol<span class="op">=</span><span class="st">"LOG_VALUE"</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    .fit(dtrain_1)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="co"># making prediction</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>dtest_1 <span class="op">=</span> model_1.transform(dtest_1)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="co"># makting regression table</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( regression_table(model_1, assembler_1) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+------------------+--------+-----------+------+------------+---------+--------------+--------------+-------------------+-------------------+
| y: LOG_VALUE     |   Beta | Exp(Beta) | Sig. | Std. Error | p-value | 95% CI Lower | 95% CI Upper | Exp(95% CI Lower) | Exp(95% CI Upper) |
+------------------+--------+-----------+------+------------+---------+--------------+--------------+-------------------+-------------------+
| ZINC2            |  0.000 |     1.000 | ***  |      0.014 |   0.000 |       -0.028 |        0.028 |             0.972 |             1.029 |
| BATHS            |  0.211 |     1.235 | ***  |      0.013 |   0.000 |        0.186 |        0.236 |             1.205 |             1.266 |
| BEDRMS           |  0.089 |     1.093 | ***  |      0.008 |   0.000 |        0.074 |        0.105 |             1.077 |             1.110 |
| PER              |  0.005 |     1.005 |      |      0.014 |   0.533 |       -0.022 |        0.032 |             0.978 |             1.032 |
| ZADULT           | -0.022 |     0.978 |      |      0.001 |   0.106 |       -0.023 |       -0.021 |             0.977 |             0.979 |
| NUNITS           | -0.001 |     0.999 |  **  |      0.030 |   0.016 |       -0.060 |        0.057 |             0.942 |             1.058 |
| EAPTBL           | -0.020 |     0.980 |      |      0.024 |   0.491 |       -0.068 |        0.027 |             0.934 |             1.028 |
| ECOM1            | -0.006 |     0.994 |      |      0.062 |   0.818 |       -0.126 |        0.115 |             0.881 |             1.122 |
| ECOM2            | -0.067 |     0.935 |      |      0.018 |   0.274 |       -0.102 |       -0.033 |             0.903 |             0.968 |
| EGREEN           |  0.006 |     1.006 |      |      0.065 |   0.717 |       -0.121 |        0.134 |             0.886 |             1.143 |
| EJUNK            | -0.215 |     0.807 | ***  |      0.029 |   0.001 |       -0.272 |       -0.158 |             0.762 |             0.854 |
| ELOW1            |  0.022 |     1.022 |      |      0.037 |   0.445 |       -0.050 |        0.094 |             0.951 |             1.099 |
| ESFD             |  0.279 |     1.322 | ***  |      0.033 |   0.000 |        0.215 |        0.343 |             1.240 |             1.409 |
| ETRANS           | -0.075 |     0.928 |  **  |      0.046 |   0.022 |       -0.165 |        0.015 |             0.848 |             1.015 |
| EABAN            | -0.178 |     0.837 | ***  |      0.041 |   0.000 |       -0.260 |       -0.097 |             0.771 |             0.907 |
| ODORA            | -0.010 |     0.990 |      |      0.020 |   0.811 |       -0.049 |        0.030 |             0.952 |             1.030 |
| STRNA            | -0.028 |     0.972 |      |      0.006 |   0.162 |       -0.039 |       -0.017 |             0.962 |             0.983 |
| INTW             | -0.048 |     0.953 | ***  |      0.017 |   0.000 |       -0.082 |       -0.014 |             0.922 |             0.986 |
| MATBUY           | -0.017 |     0.983 |      |      0.022 |   0.319 |       -0.060 |        0.025 |             0.942 |             1.026 |
| FRSTHO           | -0.083 |     0.920 | ***  |      0.037 |   0.000 |       -0.155 |       -0.011 |             0.856 |             0.989 |
| STATE_CO         | -0.294 |     0.745 | ***  |      0.039 |   0.000 |       -0.371 |       -0.218 |             0.690 |             0.804 |
| STATE_CT         | -0.327 |     0.721 | ***  |      0.039 |   0.000 |       -0.403 |       -0.251 |             0.668 |             0.778 |
| STATE_GA         | -0.615 |     0.540 | ***  |      0.071 |   0.000 |       -0.754 |       -0.477 |             0.470 |             0.621 |
| STATE_IL         | -0.862 |     0.422 | ***  |      0.038 |   0.000 |       -0.937 |       -0.787 |             0.392 |             0.455 |
| STATE_IN         | -0.736 |     0.479 | ***  |      0.046 |   0.000 |       -0.828 |       -0.645 |             0.437 |             0.524 |
| STATE_LA         | -0.712 |     0.490 | ***  |      0.043 |   0.000 |       -0.796 |       -0.629 |             0.451 |             0.533 |
| STATE_MO         | -0.645 |     0.525 | ***  |      0.041 |   0.000 |       -0.725 |       -0.565 |             0.484 |             0.569 |
| STATE_OH         | -0.636 |     0.529 | ***  |      0.041 |   0.000 |       -0.717 |       -0.556 |             0.488 |             0.573 |
| STATE_OK         | -0.996 |     0.369 | ***  |      0.043 |   0.000 |       -1.080 |       -0.913 |             0.340 |             0.401 |
| STATE_PA         | -0.891 |     0.410 | ***  |      0.043 |   0.000 |       -0.975 |       -0.806 |             0.377 |             0.447 |
| STATE_TX         | -1.045 |     0.352 | ***  |      0.039 |   0.000 |       -1.120 |       -0.969 |             0.326 |             0.379 |
| STATE_WA         | -0.089 |     0.915 |  **  |      0.023 |   0.022 |       -0.133 |       -0.044 |             0.875 |             0.957 |
| METRO_urban      |  0.092 |     1.096 | ***  |      0.029 |   0.000 |        0.034 |        0.149 |             1.035 |             1.160 |
| HHGRAD_Assoc     | -0.153 |     0.858 | ***  |      0.026 |   0.000 |       -0.205 |       -0.102 |             0.815 |             0.903 |
| HHGRAD_Grad      |  0.079 |     1.083 | ***  |      0.021 |   0.003 |        0.038 |        0.121 |             1.039 |             1.128 |
| HHGRAD_HS_Grad   | -0.178 |     0.837 | ***  |      0.037 |   0.000 |       -0.251 |       -0.106 |             0.778 |             0.899 |
| HHGRAD_No_HS     | -0.321 |     0.725 | ***  |      0.033 |   0.000 |       -0.386 |       -0.257 |             0.680 |             0.774 |
| HOWH_good        |  0.180 |     1.197 | ***  |      0.027 |   0.000 |        0.126 |        0.233 |             1.134 |             1.263 |
| HOWN_good        |  0.111 |     1.118 | ***  |      0.022 |   0.000 |        0.067 |        0.155 |             1.070 |             1.168 |
| DWNPAY_prev_home |  0.133 |     1.142 | ***  |      0.076 |   0.000 |       -0.017 |        0.283 |             0.983 |             1.326 |
| Intercept        | 11.708 |           | ***  |      0.000 |         |       11.708 |              |            11.708 |                   |
---------------------------------------------------------------------------------------------------------------------------------------------
| Observations     |  9,351 |           |      |            |         |              |              |                   |                   |
| R²               |  0.318 |           |      |            |         |              |              |                   |                   |
| RMSE             |  0.793 |           |      |            |         |              |              |                   |                   |
+------------------+--------+-----------+------+------------+---------+--------------+--------------+-------------------+-------------------+</code></pre>
</div>
</div>
<p>Each predictor variable’s statistical significance is rated by stars under the column “Sig.”. Predictors that are not statisically significant do not have any stars. We can see in the regression table that not all of the predictor variables are statistically significant. In our next Linear Regression Model, we will only include variables that are statistically significant. We can then compare the two models and decide whether or not removing non-statistically significant variables impacts the accuracy of the model and functionality of the model.</p>
</section>
<section id="new-linear-regression-model-2" class="level3">
<h3 class="anchored" data-anchor-id="new-linear-regression-model-2">New Linear Regression (Model 2)</h3>
<div class="cell" data-outputid="b74dd75e-c4f2-41f0-e015-e11bb69f1801">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># assembling predictors</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>conti_cols_2 <span class="op">=</span> [<span class="st">'ZINC2'</span>, <span class="st">'BATHS'</span>, <span class="st">'BEDRMS'</span>, <span class="st">'NUNITS'</span>, <span class="st">'EJUNK'</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>              <span class="st">'ESFD'</span>, <span class="st">'ETRANS'</span>, <span class="st">'EABAN'</span>, <span class="st">'INTW'</span>, <span class="st">'FRSTHO'</span>]</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>dummy_cols <span class="op">=</span> dummy_cols_STATE <span class="op">+</span> dummy_cols_METRO <span class="op">+</span> dummy_cols_HHGRAD <span class="op">+</span> dummy_cols_HOWH <span class="op">+</span> dummy_cols_HOWN <span class="op">+</span> dummy_cols_DWNPAY</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>assembler_predictors_2 <span class="op">=</span> (</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    conti_cols_2 <span class="op">+</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    dummy_cols</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>assembler_2 <span class="op">=</span> VectorAssembler(</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    inputCols <span class="op">=</span> assembler_predictors_2,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    outputCol <span class="op">=</span> <span class="st">"predictors"</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>dtrain_2 <span class="op">=</span> assembler_2.transform(dtrain)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>dtest_2  <span class="op">=</span> assembler_2.transform(dtest)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co"># training model</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>model_2 <span class="op">=</span> (</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    LinearRegression(featuresCol<span class="op">=</span><span class="st">"predictors"</span>,</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>                     labelCol<span class="op">=</span><span class="st">"LOG_VALUE"</span>)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    .fit(dtrain_2)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="co"># making prediction</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>dtest_2 <span class="op">=</span> model_2.transform(dtest_2)</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="co"># makting regression table</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( regression_table(model_2, assembler_2) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+------------------+--------+-----------+------+------------+---------+--------------+--------------+-------------------+-------------------+
| y: LOG_VALUE     |   Beta | Exp(Beta) | Sig. | Std. Error | p-value | 95% CI Lower | 95% CI Upper | Exp(95% CI Lower) | Exp(95% CI Upper) |
+------------------+--------+-----------+------+------------+---------+--------------+--------------+-------------------+-------------------+
| ZINC2            |  0.000 |     1.000 | ***  |      0.014 |   0.000 |       -0.028 |        0.028 |             0.972 |             1.028 |
| BATHS            |  0.213 |     1.238 | ***  |      0.012 |   0.000 |        0.190 |        0.236 |             1.210 |             1.267 |
| BEDRMS           |  0.087 |     1.091 | ***  |      0.001 |   0.000 |        0.086 |        0.088 |             1.089 |             1.092 |
| NUNITS           | -0.002 |     0.998 |  **  |      0.065 |   0.011 |       -0.129 |        0.126 |             0.879 |             1.134 |
| EJUNK            | -0.219 |     0.803 | ***  |      0.036 |   0.001 |       -0.290 |       -0.148 |             0.748 |             0.862 |
| ESFD             |  0.273 |     1.315 | ***  |      0.032 |   0.000 |        0.211 |        0.336 |             1.235 |             1.399 |
| ETRANS           | -0.088 |     0.916 | ***  |      0.045 |   0.006 |       -0.177 |        0.001 |             0.838 |             1.001 |
| EABAN            | -0.188 |     0.829 | ***  |      0.005 |   0.000 |       -0.198 |       -0.177 |             0.820 |             0.838 |
| INTW             | -0.049 |     0.952 | ***  |      0.022 |   0.000 |       -0.092 |       -0.007 |             0.912 |             0.993 |
| FRSTHO           | -0.084 |     0.919 | ***  |      0.037 |   0.000 |       -0.156 |       -0.013 |             0.856 |             0.988 |
| STATE_CO         | -0.290 |     0.748 | ***  |      0.039 |   0.000 |       -0.366 |       -0.213 |             0.693 |             0.808 |
| STATE_CT         | -0.328 |     0.720 | ***  |      0.038 |   0.000 |       -0.403 |       -0.253 |             0.668 |             0.777 |
| STATE_GA         | -0.615 |     0.541 | ***  |      0.071 |   0.000 |       -0.754 |       -0.477 |             0.471 |             0.621 |
| STATE_IL         | -0.867 |     0.420 | ***  |      0.038 |   0.000 |       -0.942 |       -0.793 |             0.390 |             0.453 |
| STATE_IN         | -0.736 |     0.479 | ***  |      0.046 |   0.000 |       -0.826 |       -0.645 |             0.438 |             0.525 |
| STATE_LA         | -0.716 |     0.489 | ***  |      0.043 |   0.000 |       -0.799 |       -0.633 |             0.450 |             0.531 |
| STATE_MO         | -0.645 |     0.525 | ***  |      0.041 |   0.000 |       -0.724 |       -0.565 |             0.485 |             0.568 |
| STATE_OH         | -0.640 |     0.527 | ***  |      0.041 |   0.000 |       -0.720 |       -0.561 |             0.487 |             0.571 |
| STATE_OK         | -0.997 |     0.369 | ***  |      0.042 |   0.000 |       -1.081 |       -0.914 |             0.339 |             0.401 |
| STATE_PA         | -0.892 |     0.410 | ***  |      0.043 |   0.000 |       -0.976 |       -0.808 |             0.377 |             0.446 |
| STATE_TX         | -1.047 |     0.351 | ***  |      0.039 |   0.000 |       -1.122 |       -0.971 |             0.326 |             0.379 |
| STATE_WA         | -0.089 |     0.915 |  **  |      0.022 |   0.021 |       -0.133 |       -0.045 |             0.876 |             0.956 |
| METRO_urban      |  0.087 |     1.090 | ***  |      0.029 |   0.000 |        0.030 |        0.144 |             1.030 |             1.154 |
| HHGRAD_Assoc     | -0.157 |     0.855 | ***  |      0.026 |   0.000 |       -0.208 |       -0.105 |             0.812 |             0.900 |
| HHGRAD_Grad      |  0.080 |     1.083 | ***  |      0.021 |   0.003 |        0.039 |        0.121 |             1.039 |             1.128 |
| HHGRAD_HS_Grad   | -0.183 |     0.833 | ***  |      0.037 |   0.000 |       -0.255 |       -0.111 |             0.775 |             0.895 |
| HHGRAD_No_HS     | -0.329 |     0.719 | ***  |      0.033 |   0.000 |       -0.394 |       -0.265 |             0.675 |             0.767 |
| HOWH_good        |  0.180 |     1.197 | ***  |      0.027 |   0.000 |        0.127 |        0.233 |             1.136 |             1.262 |
| HOWN_good        |  0.119 |     1.126 | ***  |      0.022 |   0.000 |        0.075 |        0.163 |             1.078 |             1.177 |
| DWNPAY_prev_home |  0.133 |     1.143 | ***  |      0.073 |   0.000 |       -0.009 |        0.276 |             0.991 |             1.318 |
| Intercept        | 11.677 |           | ***  |      0.000 |         |       11.677 |              |            11.677 |                   |
---------------------------------------------------------------------------------------------------------------------------------------------
| Observations     |  9,351 |           |      |            |         |              |              |                   |                   |
| R²               |  0.318 |           |      |            |         |              |              |                   |                   |
| RMSE             |  0.794 |           |      |            |         |              |              |                   |                   |
+------------------+--------+-----------+------+------------+---------+--------------+--------------+-------------------+-------------------+</code></pre>
</div>
</div>
</section>
<section id="model-comparison" class="level3">
<h3 class="anchored" data-anchor-id="model-comparison">Model Comparison</h3>
<p>We can compare the models by looking for differences in their beta, <span class="math inline">\(R^2\)</span>, and RMSE values, as well as their residual plots.</p>
<section id="beta-and-r2-values" class="level4">
<h4 class="anchored" data-anchor-id="beta-and-r2-values">Beta and <span class="math inline">\(R^2\)</span> values</h4>
<div class="cell" data-outputid="b4cda7f3-6928-4505-962b-8f3cb6c3336f">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(compare_reg_models([model_1, model_2],</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>                        [assembler_1, assembler_2],</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                        [<span class="st">"Model 1"</span>, <span class="st">"Model 2"</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--------------------------------------------------------------------------
+------------------+--------------------------+--------------------------+
| Predictor        |   y: LOG_VALUE (Model 1) |   y: LOG_VALUE (Model 2) |
--------------------------------------------------------------------------
+==================+==========================+==========================+
| ZINC2            |         0.000*** / 1.000 |         0.000*** / 1.000 |
+------------------+--------------------------+--------------------------+
| BATHS            |         0.211*** / 1.235 |         0.213*** / 1.238 |
+------------------+--------------------------+--------------------------+
| BEDRMS           |         0.089*** / 1.093 |         0.087*** / 1.091 |
+------------------+--------------------------+--------------------------+
| PER              |            0.005 / 1.005 |                          |
+------------------+--------------------------+--------------------------+
| ZADULT           |           -0.022 / 0.978 |                          |
+------------------+--------------------------+--------------------------+
| NUNITS           |         -0.001** / 0.999 |         -0.002** / 0.998 |
+------------------+--------------------------+--------------------------+
| EAPTBL           |           -0.020 / 0.980 |                          |
+------------------+--------------------------+--------------------------+
| ECOM1            |           -0.006 / 0.994 |                          |
+------------------+--------------------------+--------------------------+
| ECOM2            |           -0.067 / 0.935 |                          |
+------------------+--------------------------+--------------------------+
| EGREEN           |            0.006 / 1.006 |                          |
+------------------+--------------------------+--------------------------+
| EJUNK            |        -0.215*** / 0.807 |        -0.219*** / 0.803 |
+------------------+--------------------------+--------------------------+
| ELOW1            |            0.022 / 1.022 |                          |
+------------------+--------------------------+--------------------------+
| ESFD             |         0.279*** / 1.322 |         0.273*** / 1.315 |
+------------------+--------------------------+--------------------------+
| ETRANS           |         -0.075** / 0.928 |        -0.088*** / 0.916 |
+------------------+--------------------------+--------------------------+
| EABAN            |        -0.178*** / 0.837 |        -0.188*** / 0.829 |
+------------------+--------------------------+--------------------------+
| ODORA            |           -0.010 / 0.990 |                          |
+------------------+--------------------------+--------------------------+
| STRNA            |           -0.028 / 0.972 |                          |
+------------------+--------------------------+--------------------------+
| INTW             |        -0.048*** / 0.953 |        -0.049*** / 0.952 |
+------------------+--------------------------+--------------------------+
| MATBUY           |           -0.017 / 0.983 |                          |
+------------------+--------------------------+--------------------------+
| FRSTHO           |        -0.083*** / 0.920 |        -0.084*** / 0.919 |
+------------------+--------------------------+--------------------------+
| STATE_CO         |        -0.294*** / 0.745 |        -0.290*** / 0.748 |
+------------------+--------------------------+--------------------------+
| STATE_CT         |        -0.327*** / 0.721 |        -0.328*** / 0.720 |
+------------------+--------------------------+--------------------------+
| STATE_GA         |        -0.615*** / 0.540 |        -0.615*** / 0.541 |
+------------------+--------------------------+--------------------------+
| STATE_IL         |        -0.862*** / 0.422 |        -0.867*** / 0.420 |
+------------------+--------------------------+--------------------------+
| STATE_IN         |        -0.736*** / 0.479 |        -0.736*** / 0.479 |
+------------------+--------------------------+--------------------------+
| STATE_LA         |        -0.712*** / 0.490 |        -0.716*** / 0.489 |
+------------------+--------------------------+--------------------------+
| STATE_MO         |        -0.645*** / 0.525 |        -0.645*** / 0.525 |
+------------------+--------------------------+--------------------------+
| STATE_OH         |        -0.636*** / 0.529 |        -0.640*** / 0.527 |
+------------------+--------------------------+--------------------------+
| STATE_OK         |        -0.996*** / 0.369 |        -0.997*** / 0.369 |
+------------------+--------------------------+--------------------------+
| STATE_PA         |        -0.891*** / 0.410 |        -0.892*** / 0.410 |
+------------------+--------------------------+--------------------------+
| STATE_TX         |        -1.045*** / 0.352 |        -1.047*** / 0.351 |
+------------------+--------------------------+--------------------------+
| STATE_WA         |         -0.089** / 0.915 |         -0.089** / 0.915 |
+------------------+--------------------------+--------------------------+
| METRO_urban      |         0.092*** / 1.096 |         0.087*** / 1.090 |
+------------------+--------------------------+--------------------------+
| HHGRAD_Assoc     |        -0.153*** / 0.858 |        -0.157*** / 0.855 |
+------------------+--------------------------+--------------------------+
| HHGRAD_Grad      |         0.079*** / 1.083 |         0.080*** / 1.083 |
+------------------+--------------------------+--------------------------+
| HHGRAD_HS_Grad   |        -0.178*** / 0.837 |        -0.183*** / 0.833 |
+------------------+--------------------------+--------------------------+
| HHGRAD_No_HS     |        -0.321*** / 0.725 |        -0.329*** / 0.719 |
+------------------+--------------------------+--------------------------+
| HOWH_good        |         0.180*** / 1.197 |         0.180*** / 1.197 |
+------------------+--------------------------+--------------------------+
| HOWN_good        |         0.111*** / 1.118 |         0.119*** / 1.126 |
+------------------+--------------------------+--------------------------+
| DWNPAY_prev_home |         0.133*** / 1.142 |         0.133*** / 1.143 |
+------------------+--------------------------+--------------------------+
| Intercept        |                11.708*** |                11.677*** |
==========================================================================
| Observations     |                    9,351 |                    9,351 |
+------------------+--------------------------+--------------------------+
| R²               |                    0.318 |                    0.318 |
+------------------+--------------------------+--------------------------+
| RMSE             |                    0.793 |                    0.794 |
+------------------+--------------------------+--------------------------+
--------------------------------------------------------------------------</code></pre>
</div>
</div>
<p><strong>The two models generally have similar or the same beta values for each predictor. They also have the same <span class="math inline">\(R^2\)</span> values. This suggests that one of the models may not be more accurate in predicting house value than the other and that the two are functionally equivalent.</strong></p>
</section>
<section id="rmse" class="level4">
<h4 class="anchored" data-anchor-id="rmse">RMSE</h4>
<div class="cell" data-outputid="19760a8d-5318-4ace-adc0-8b4abe045353">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(compare_rmse([dtest_1, dtest_2], <span class="st">"LOG_VALUE"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+------+-----------+-----------+
|      |   Model 1 |   Model 2 |
+======+===========+===========+
| RMSE |     0.851 |     0.852 |
+------+-----------+-----------+</code></pre>
</div>
</div>
<p><strong>The RMSE values for the two models are relatively the same, with Model 1 having a slightly lower value. This suggests that Model 1 may be a slightly better fit for the data.</strong></p>
</section>
<section id="residual-plots" class="level4">
<h4 class="anchored" data-anchor-id="residual-plots">Residual Plots</h4>
<div class="cell" data-outputid="12c61621-1d53-4c9e-c870-108ad7fe8705">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>residual_plot(dtest_1, <span class="st">"LOG_VALUE"</span>, <span class="st">"Model 1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="hw4_pt_3_files/figure-html/cell-22-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="1b330cda-ff7a-4a9f-cbe5-5396ec4402a0">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>residual_plot(dtest_2, <span class="st">"LOG_VALUE"</span>, <span class="st">"Model 2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="hw4_pt_3_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><strong>The residual plots for Model 1 and Model 2 look relatively the same. This shows us that the models are able to predict the home value with the same or similar accuracy.</strong></p>
<p><strong>Overall, the residual plots, beta values, <span class="math inline">\(R^2\)</span> values, and RMSE values were relatively the same for both models. This proves that the variables removed in Model 2 were in fact not statistically significant. Their removal did not have a major impact on the Linear Regression model.</strong></p>
</section>
</section>
</section>
<section id="logistic-regression" class="level2">
<h2 class="anchored" data-anchor-id="logistic-regression">Logistic Regression</h2>
<p>Next, we will build a Logistic Regression Model using the same DataFrame, <code>homes</code>. However, this time we will have the model predict whether the buyer made a down payment of 20% or more. This outcome variable will be a new variable named “GT20DOWN”. Our predictor variables will once again be all available variables, excluding the amount of the first mortgage and the purchase price of the unit and land.</p>
<section id="outcome-variable" class="level3">
<h3 class="anchored" data-anchor-id="outcome-variable">Outcome Variable</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">"GT20DOWN"</span>, when((col(<span class="st">"LPRICE"</span>) <span class="op">-</span> col(<span class="st">"AMMORT"</span>)) <span class="op">/</span> col(<span class="st">"LPRICE"</span>) <span class="op">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>).otherwise(<span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="split-into-trainingtesting" class="level3">
<h3 class="anchored" data-anchor-id="split-into-trainingtesting">Split into Training/Testing</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>dtrain, dtest <span class="op">=</span> df.randomSplit([<span class="fl">0.6</span>, <span class="fl">0.4</span>], seed<span class="op">=</span><span class="dv">1234</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dummy-variables" class="level3">
<h3 class="anchored" data-anchor-id="dummy-variables">Dummy Variables</h3>
<div class="cell" data-outputid="2175164b-3e4e-4cb4-a118-065a5843574b">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>dummy_cols_STATE, ref_category_STATE <span class="op">=</span> add_dummy_variables(<span class="st">'STATE'</span>, <span class="dv">0</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>dummy_cols_METRO, ref_category_METRO <span class="op">=</span> add_dummy_variables(<span class="st">'METRO'</span>, <span class="dv">0</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>dummy_cols_HHGRAD, ref_category_HHGRAD <span class="op">=</span> add_dummy_variables(<span class="st">'HHGRAD'</span>, <span class="dv">1</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>dummy_cols_HOWH, ref_category_HOWH <span class="op">=</span> add_dummy_variables(<span class="st">'HOWH'</span>, <span class="dv">0</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>dummy_cols_HOWN, ref_category_HOWN <span class="op">=</span> add_dummy_variables(<span class="st">'HOWN'</span>, <span class="dv">0</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>dummy_cols_DWNPAY, ref_category_DWNPAY <span class="op">=</span> add_dummy_variables(<span class="st">'DWNPAY'</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reference category (dummy omitted): CA
Reference category (dummy omitted): rural
Reference category (dummy omitted): Bach
Reference category (dummy omitted): bad
Reference category (dummy omitted): bad
Reference category (dummy omitted): other</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep the name assembler_predictors unchanged,</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   as it will be used as a global variable in the marginal_effects UDF.</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>assembler_predictors <span class="op">=</span> (</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    conti_cols_2 <span class="op">+</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    dummy_cols</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>assembler_3 <span class="op">=</span> VectorAssembler(</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    inputCols <span class="op">=</span> assembler_predictors,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    outputCol <span class="op">=</span> <span class="st">"predictors"</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>dtrain_3 <span class="op">=</span> assembler_3.transform(dtrain)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>dtest_3  <span class="op">=</span> assembler_3.transform(dtest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># training the model</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>model_3 <span class="op">=</span> (</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    GeneralizedLinearRegression(featuresCol<span class="op">=</span><span class="st">"predictors"</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>                                labelCol<span class="op">=</span><span class="st">"GT20DOWN"</span>,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>                                family<span class="op">=</span><span class="st">"binomial"</span>,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>                                link<span class="op">=</span><span class="st">"logit"</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    .fit(dtrain_3)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>dtrain_3 <span class="op">=</span> model_3.transform(dtrain_3)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>dtest_3 <span class="op">=</span> model_3.transform(dtest_3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="a709be69-856d-4557-ab25-f9cc4172359d">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>model_3.summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>Coefficients:
         Feature Estimate Std Error  T Value P Value
     (Intercept)   0.7348    0.1998   3.6781  0.0002
           ZINC2   0.0000    0.0000   0.8766  0.3807
           BATHS   0.2872    0.0407   7.0522  0.0000
          BEDRMS  -0.0784    0.0323  -2.4263  0.0153
          NUNITS   0.0129    0.0061   2.1077  0.0351
           EJUNK  -0.2353    0.1723  -1.3658  0.1720
            ESFD  -0.2221    0.0997  -2.2287  0.0258
          ETRANS  -0.1349    0.0844  -1.5981  0.1100
           EABAN  -0.3862    0.1205  -3.2045  0.0014
            INTW  -0.0686    0.0148  -4.6394  0.0000
          FRSTHO  -0.3151    0.0568  -5.5470  0.0000
        STATE_CO  -0.1912    0.0984  -1.9438  0.0519
        STATE_CT   0.7224    0.1092   6.6139  0.0000
        STATE_GA   0.0132    0.1038   0.1277  0.8984
        STATE_IL   0.3506    0.1939   1.8087  0.0705
        STATE_IN   0.2030    0.1031   1.9687  0.0490
        STATE_LA   0.4599    0.1255   3.6651  0.0002
        STATE_MO   0.2093    0.1154   1.8130  0.0698
        STATE_OH   0.5330    0.1115   4.7800  0.0000
        STATE_OK   0.0986    0.1092   0.9034  0.3663
        STATE_PA   0.2630    0.1146   2.2937  0.0218
        STATE_TX   0.1307    0.1147   1.1400  0.2543
        STATE_WA   0.1071    0.1041   1.0287  0.3036
     METRO_urban   0.0673    0.0603   1.1174  0.2638
    HHGRAD_Assoc  -0.6806    0.0783  -8.6891  0.0000
     HHGRAD_Grad  -0.0532    0.0764  -0.6958  0.4865
  HHGRAD_HS_Grad  -0.6810    0.0579 -11.7598  0.0000
    HHGRAD_No_HS  -0.8795    0.0977  -9.0009  0.0000
       HOWH_good   0.0314    0.0871   0.3603  0.7186
       HOWN_good   0.2052    0.0715   2.8701  0.0041
DWNPAY_prev_home   0.6042    0.0620   9.7496  0.0000

(Dispersion parameter for binomial family taken to be 1.0000)
    Null deviance: 12511.4865 on 9320 degrees of freedom
Residual deviance: 11489.7938 on 9320 degrees of freedom
AIC: 11551.7938</code></pre>
</div>
</div>
</section>
<section id="marginal-effects" class="level3">
<h3 class="anchored" data-anchor-id="marginal-effects">Marginal Effects</h3>
<p>We can use the marginal effect of a predictor variable to analyze the relationship or association between the predictor and outcome variable. In this case, we will interpret the association between first-time homeownership and the probability of making a 20%+ down payment. Additionally, we will be able to interpret the association between number of bedrooms in the home and the probability of making a 20%+ down payment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute means</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>means_df <span class="op">=</span> dtrain_3.select([mean(col).alias(col) <span class="cf">for</span> col <span class="kw">in</span> assembler_predictors])</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect the results as a list</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>means <span class="op">=</span> means_df.collect()[<span class="dv">0</span>]</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>means_list <span class="op">=</span> [means[col] <span class="cf">for</span> col <span class="kw">in</span> assembler_predictors]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="2607f369-13bf-4cce-ec21-2b115e636560">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>table_output, df_ME <span class="op">=</span> marginal_effects(model_3, means_list)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(table_output)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+------------------+-----------------+--------------+------------+--------------+--------------+
| Variable         | Marginal Effect | Significance | Std. Error | 95% CI Lower | 95% CI Upper |
+------------------+-----------------+--------------+------------+--------------+--------------+
| ZINC2            |          0.0000 |              |     0.0000 |      -0.0000 |       0.0000 |
| BATHS            |          0.0674 | ***          |     0.0096 |       0.0487 |       0.0861 |
| BEDRMS           |         -0.0184 | **           |     0.0076 |      -0.0333 |      -0.0035 |
| NUNITS           |          0.0030 | **           |     0.0014 |       0.0002 |       0.0058 |
| EJUNK            |         -0.0552 |              |     0.0404 |      -0.1345 |       0.0240 |
| ESFD             |         -0.0521 | **           |     0.0234 |      -0.0980 |      -0.0063 |
| ETRANS           |         -0.0316 |              |     0.0198 |      -0.0705 |       0.0072 |
| EABAN            |         -0.0906 | ***          |     0.0283 |      -0.1461 |      -0.0352 |
| INTW             |         -0.0161 | ***          |     0.0035 |      -0.0229 |      -0.0093 |
| FRSTHO           |         -0.0739 | ***          |     0.0133 |      -0.1001 |      -0.0478 |
| STATE_CO         |         -0.0449 | *            |     0.0231 |      -0.0901 |       0.0004 |
| STATE_CT         |          0.1695 | ***          |     0.0256 |       0.1193 |       0.2198 |
| STATE_GA         |          0.0031 |              |     0.0244 |      -0.0446 |       0.0508 |
| STATE_IL         |          0.0823 | *            |     0.0455 |      -0.0069 |       0.1714 |
| STATE_IN         |          0.0476 | **           |     0.0242 |       0.0002 |       0.0951 |
| STATE_LA         |          0.1079 | ***          |     0.0294 |       0.0502 |       0.1656 |
| STATE_MO         |          0.0491 | *            |     0.0271 |      -0.0040 |       0.1022 |
| STATE_OH         |          0.1251 | ***          |     0.0262 |       0.0738 |       0.1764 |
| STATE_OK         |          0.0231 |              |     0.0256 |      -0.0271 |       0.0734 |
| STATE_PA         |          0.0617 | **           |     0.0269 |       0.0090 |       0.1144 |
| STATE_TX         |          0.0307 |              |     0.0269 |      -0.0221 |       0.0834 |
| STATE_WA         |          0.0251 |              |     0.0244 |      -0.0228 |       0.0730 |
| METRO_urban      |          0.0158 |              |     0.0141 |      -0.0119 |       0.0435 |
| HHGRAD_Assoc     |         -0.1597 | ***          |     0.0184 |      -0.1957 |      -0.1237 |
| HHGRAD_Grad      |         -0.0125 |              |     0.0179 |      -0.0476 |       0.0227 |
| HHGRAD_HS_Grad   |         -0.1598 | ***          |     0.0136 |      -0.1864 |      -0.1332 |
| HHGRAD_No_HS     |         -0.2064 | ***          |     0.0229 |      -0.2513 |      -0.1614 |
| HOWH_good        |          0.0074 |              |     0.0204 |      -0.0327 |       0.0474 |
| HOWN_good        |          0.0482 | ***          |     0.0168 |       0.0153 |       0.0810 |
| DWNPAY_prev_home |          0.1418 | ***          |     0.0145 |       0.1133 |       0.1703 |
+------------------+-----------------+--------------+------------+--------------+--------------+</code></pre>
</div>
</div>
<p><strong>The marginal effect of first time homebuyers (FRSTHO) is <span class="math inline">\(-0.0739\)</span>. This shows that first time home buyers are 7.39% less likely to make a 20% down payment.</strong></p>
<p><strong>The marginal effect of the number of bedrooms (BEDRMS) is <span class="math inline">\(-0.0184\)</span>. This shows that an additional bedroom is associated with a 1.84% lower probability of making a 20% down payment.</strong></p>
</section>
</section>
<section id="adding-interaction-terms" class="level2">
<h2 class="anchored" data-anchor-id="adding-interaction-terms">Adding Interaction Terms</h2>
<p>Let’s take a closer look at the relationship between number of bedrooms, first-time homebuyers, and the probability of making a 20%+ down payment. To do this, we will fit a new Logistic Regression Model using all the previously included predictors, plus the interaction between first-time homebuyers, <code>FRSTHO</code>, and number of bedrooms, <code>BEDRMS</code>. This will allow us to interpret how the relationship between the number of bedrooms and the probability of making a 20%+ down payment varies depending on whether the buyer is a first-time homebuyer.</p>
<section id="interaction-between-frstho-and-bedrms" class="level3">
<h3 class="anchored" data-anchor-id="interaction-between-frstho-and-bedrms">Interaction Between <code>FRSTHO</code> and <code>BEDRMS</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>interaction_cols_FRSTHO_BEDRMS <span class="op">=</span> add_interaction_terms([<span class="st">'FRSTHO'</span>], [<span class="st">'BEDRMS'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="new-logistic-regression-with-interaction-terms" class="level3">
<h3 class="anchored" data-anchor-id="new-logistic-regression-with-interaction-terms">New Logistic Regression (with Interaction Terms)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>assembler_predictors <span class="op">=</span> (</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    conti_cols_2 <span class="op">+</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    dummy_cols <span class="op">+</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    interaction_cols_FRSTHO_BEDRMS</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>assembler_4 <span class="op">=</span> VectorAssembler(</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    inputCols <span class="op">=</span> assembler_predictors,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    outputCol <span class="op">=</span> <span class="st">"predictors"</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>dtrain_4 <span class="op">=</span> assembler_4.transform(dtrain)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>dtest_4  <span class="op">=</span> assembler_4.transform(dtest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># training the model</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>model_4 <span class="op">=</span> (</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    GeneralizedLinearRegression(featuresCol<span class="op">=</span><span class="st">"predictors"</span>,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                                labelCol<span class="op">=</span><span class="st">"GT20DOWN"</span>,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                                family<span class="op">=</span><span class="st">"binomial"</span>,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>                                link<span class="op">=</span><span class="st">"logit"</span>)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    .fit(dtrain_4)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>dtrain_4 <span class="op">=</span> model_4.transform(dtrain_4)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>dtest_4 <span class="op">=</span> model_4.transform(dtest_4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="27510067-6383-4f65-c6b7-291830edacdc">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>model_4.summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>Coefficients:
         Feature Estimate Std Error  T Value P Value
     (Intercept)   0.5973    0.2126   2.8099  0.0050
           ZINC2   0.0000    0.0000   0.8195  0.4125
           BATHS   0.2829    0.0408   6.9307  0.0000
          BEDRMS  -0.0322    0.0406  -0.7929  0.4278
          NUNITS   0.0126    0.0060   2.0798  0.0375
           EJUNK  -0.2374    0.1721  -1.3793  0.1678
            ESFD  -0.2240    0.0995  -2.2500  0.0244
          ETRANS  -0.1363    0.0844  -1.6158  0.1061
           EABAN  -0.3890    0.1205  -3.2279  0.0012
            INTW  -0.0684    0.0148  -4.6252  0.0000
          FRSTHO   0.0198    0.1860   0.1066  0.9151
        STATE_CO  -0.1957    0.0984  -1.9878  0.0468
        STATE_CT   0.7175    0.1092   6.5688  0.0000
        STATE_GA   0.0121    0.1039   0.1167  0.9071
        STATE_IL   0.3454    0.1938   1.7820  0.0748
        STATE_IN   0.2013    0.1031   1.9519  0.0509
        STATE_LA   0.4578    0.1255   3.6480  0.0003
        STATE_MO   0.2041    0.1155   1.7673  0.0772
        STATE_OH   0.5293    0.1116   4.7445  0.0000
        STATE_OK   0.0965    0.1092   0.8835  0.3770
        STATE_PA   0.2544    0.1147   2.2174  0.0266
        STATE_TX   0.1285    0.1147   1.1201  0.2627
        STATE_WA   0.1046    0.1042   1.0044  0.3152
     METRO_urban   0.0646    0.0603   1.0714  0.2840
    HHGRAD_Assoc  -0.6796    0.0783  -8.6746  0.0000
     HHGRAD_Grad  -0.0526    0.0764  -0.6876  0.4917
  HHGRAD_HS_Grad  -0.6788    0.0579 -11.7180  0.0000
    HHGRAD_No_HS  -0.8770    0.0977  -8.9786  0.0000
       HOWH_good   0.0339    0.0871   0.3892  0.6971
       HOWN_good   0.2036    0.0715   2.8474  0.0044
DWNPAY_prev_home   0.5951    0.0622   9.5746  0.0000
 FRSTHO_*_BEDRMS  -0.1076    0.0569  -1.8905  0.0587

(Dispersion parameter for binomial family taken to be 1.0000)
    Null deviance: 12511.4865 on 9319 degrees of freedom
Residual deviance: 11486.2166 on 9319 degrees of freedom
AIC: 11550.2166</code></pre>
</div>
</div>
<p><strong>The coefficient of the interaction term between first time homebuyers (FRSTHO) and number of bedrooms (BEDRMS) is <span class="math inline">\(-0.1076\)</span>. This means that for first time homebuyers, each additional bedroom decreases the chance that the homebuyer will make a 20% down payment by 0.1076 units.</strong></p>
</section>
<section id="marginal-effects-1" class="level3">
<h3 class="anchored" data-anchor-id="marginal-effects-1">Marginal Effects</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute means</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>means_df <span class="op">=</span> dtrain_4.select([mean(col).alias(col) <span class="cf">for</span> col <span class="kw">in</span> assembler_predictors])</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect the results as a list</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>means <span class="op">=</span> means_df.collect()[<span class="dv">0</span>]</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>means_list <span class="op">=</span> [means[col] <span class="cf">for</span> col <span class="kw">in</span> assembler_predictors]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="89ed257b-3016-46bc-a8bc-5c7d0dc65876">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>table_output, df_ME <span class="op">=</span> marginal_effects(model_4, means_list) <span class="co"># Instead of mean values, some other representative values can also be chosen.</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(table_output)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+------------------+-----------------+--------------+------------+--------------+--------------+
| Variable         | Marginal Effect | Significance | Std. Error | 95% CI Lower | 95% CI Upper |
+------------------+-----------------+--------------+------------+--------------+--------------+
| ZINC2            |          0.0000 |              |     0.0000 |      -0.0000 |       0.0000 |
| BATHS            |          0.0664 | ***          |     0.0096 |       0.0476 |       0.0852 |
| BEDRMS           |         -0.0076 |              |     0.0095 |      -0.0262 |       0.0111 |
| NUNITS           |          0.0029 | **           |     0.0014 |       0.0002 |       0.0057 |
| EJUNK            |         -0.0557 |              |     0.0404 |      -0.1349 |       0.0235 |
| ESFD             |         -0.0526 | **           |     0.0234 |      -0.0983 |      -0.0068 |
| ETRANS           |         -0.0320 |              |     0.0198 |      -0.0708 |       0.0068 |
| EABAN            |         -0.0913 | ***          |     0.0283 |      -0.1467 |      -0.0358 |
| INTW             |         -0.0160 | ***          |     0.0035 |      -0.0228 |      -0.0092 |
| FRSTHO           |          0.0047 |              |     0.0436 |      -0.0809 |       0.0902 |
| STATE_CO         |         -0.0459 | **           |     0.0231 |      -0.0912 |      -0.0006 |
| STATE_CT         |          0.1684 | ***          |     0.0256 |       0.1181 |       0.2186 |
| STATE_GA         |          0.0028 |              |     0.0244 |      -0.0449 |       0.0506 |
| STATE_IL         |          0.0810 | *            |     0.0455 |      -0.0081 |       0.1702 |
| STATE_IN         |          0.0472 | *            |     0.0242 |      -0.0002 |       0.0947 |
| STATE_LA         |          0.1074 | ***          |     0.0294 |       0.0497 |       0.1651 |
| STATE_MO         |          0.0479 | *            |     0.0271 |      -0.0052 |       0.1010 |
| STATE_OH         |          0.1242 | ***          |     0.0262 |       0.0729 |       0.1755 |
| STATE_OK         |          0.0226 |              |     0.0256 |      -0.0276 |       0.0729 |
| STATE_PA         |          0.0597 | **           |     0.0269 |       0.0069 |       0.1125 |
| STATE_TX         |          0.0301 |              |     0.0269 |      -0.0226 |       0.0829 |
| STATE_WA         |          0.0245 |              |     0.0244 |      -0.0234 |       0.0724 |
| METRO_urban      |          0.0151 |              |     0.0141 |      -0.0126 |       0.0429 |
| HHGRAD_Assoc     |         -0.1595 | ***          |     0.0184 |      -0.1955 |      -0.1234 |
| HHGRAD_Grad      |         -0.0123 |              |     0.0179 |      -0.0475 |       0.0228 |
| HHGRAD_HS_Grad   |         -0.1593 | ***          |     0.0136 |      -0.1859 |      -0.1326 |
| HHGRAD_No_HS     |         -0.2058 | ***          |     0.0229 |      -0.2507 |      -0.1609 |
| HOWH_good        |          0.0080 |              |     0.0204 |      -0.0321 |       0.0480 |
| HOWN_good        |          0.0478 | ***          |     0.0168 |       0.0149 |       0.0807 |
| DWNPAY_prev_home |          0.1396 | ***          |     0.0146 |       0.1110 |       0.1682 |
| FRSTHO_*_BEDRMS  |         -0.0253 | *            |     0.0134 |      -0.0514 |       0.0009 |
+------------------+-----------------+--------------+------------+--------------+--------------+</code></pre>
</div>
</div>
<p><strong>The marginal effect of the interaction term between first time homebuyers (FRSTHO) and number of bedrooms (BEDRMS) is <span class="math inline">\(-0.0253\)</span>. This means that for each additional bedroom, first time homebuyers are 2.53% less likely to make a 20% down payment compared to non-first time homebuyers.</strong></p>
</section>
</section>
<section id="two-more-logistic-regression-models" class="level2">
<h2 class="anchored" data-anchor-id="two-more-logistic-regression-models">Two More Logistic Regression Models</h2>
<p>Finally, we will fit two more Logistic Regression Models in order to predict home value for two subsets of home data. One subset and model will feature only homes worth greater than or equal to 175k. The other subset will feature homes worth less than 175k. We can compare the models’ residual deviance, <span class="math inline">\(RMSE\)</span>, and classification performance to evaluate whether or not performance changes for different home value levels.</p>
<section id="split-dataframe" class="level3">
<h3 class="anchored" data-anchor-id="split-dataframe">Split DataFrame</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>greater_than_equal_175000 <span class="op">=</span> df[df[<span class="st">'VALUE'</span>] <span class="op">&gt;=</span> <span class="dv">175000</span>]</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>less_than_175000 <span class="op">=</span> df[df[<span class="st">'VALUE'</span>] <span class="op">&lt;</span> <span class="dv">175000</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="homes-worth-value-175k" class="level3">
<h3 class="anchored" data-anchor-id="homes-worth-value-175k">Homes worth VALUE ≥ 175k</h3>
<section id="split-into-trainingtesting-1" class="level4">
<h4 class="anchored" data-anchor-id="split-into-trainingtesting-1">Split into Training/Testing</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>dtrain, dtest <span class="op">=</span> greater_than_equal_175000.randomSplit([<span class="fl">0.6</span>, <span class="fl">0.4</span>], seed<span class="op">=</span><span class="dv">1234</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dummy-variables-1" class="level4">
<h4 class="anchored" data-anchor-id="dummy-variables-1">Dummy Variables</h4>
<div class="cell" data-outputid="e25673e5-05e5-418b-a3e3-bc0ef1b31125">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>dummy_cols_STATE, ref_category_STATE <span class="op">=</span> add_dummy_variables(<span class="st">'STATE'</span>, <span class="dv">0</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>dummy_cols_METRO, ref_category_METRO <span class="op">=</span> add_dummy_variables(<span class="st">'METRO'</span>, <span class="dv">0</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>dummy_cols_HHGRAD, ref_category_HHGRAD <span class="op">=</span> add_dummy_variables(<span class="st">'HHGRAD'</span>, <span class="dv">1</span>)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>dummy_cols_HOWH, ref_category_HOWH <span class="op">=</span> add_dummy_variables(<span class="st">'HOWH'</span>, <span class="dv">0</span>)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>dummy_cols_HOWN, ref_category_HOWN <span class="op">=</span> add_dummy_variables(<span class="st">'HOWN'</span>, <span class="dv">0</span>)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>dummy_cols_DWNPAY, ref_category_DWNPAY <span class="op">=</span> add_dummy_variables(<span class="st">'DWNPAY'</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reference category (dummy omitted): CA
Reference category (dummy omitted): rural
Reference category (dummy omitted): Bach
Reference category (dummy omitted): bad
Reference category (dummy omitted): bad
Reference category (dummy omitted): other</code></pre>
</div>
</div>
</section>
<section id="logistic-regression-model" class="level4">
<h4 class="anchored" data-anchor-id="logistic-regression-model">Logistic Regression Model</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>assembler_predictors <span class="op">=</span> (</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    conti_cols_2 <span class="op">+</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    dummy_cols</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>assembler_5 <span class="op">=</span> VectorAssembler(</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    inputCols <span class="op">=</span> assembler_predictors,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    outputCol <span class="op">=</span> <span class="st">"predictors"</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>dtrain_5 <span class="op">=</span> assembler_5.transform(dtrain)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>dtest_5  <span class="op">=</span> assembler_5.transform(dtest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># training the model</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>model_5 <span class="op">=</span> (</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    GeneralizedLinearRegression(featuresCol<span class="op">=</span><span class="st">"predictors"</span>,</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>                                labelCol<span class="op">=</span><span class="st">"GT20DOWN"</span>,</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                                family<span class="op">=</span><span class="st">"binomial"</span>,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                                link<span class="op">=</span><span class="st">"logit"</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    .fit(dtrain_5)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>dtrain_5 <span class="op">=</span> model_5.transform(dtrain_5)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>dtest_5 <span class="op">=</span> model_5.transform(dtest_5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="3851d995-d466-4b24-e78f-0e88dcb45f5d">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>model_5.summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>Coefficients:
         Feature Estimate Std Error T Value P Value
     (Intercept)   0.6684    0.3251  2.0562  0.0398
           ZINC2   0.0000    0.0000 -0.0764  0.9391
           BATHS   0.3301    0.0567  5.8208  0.0000
          BEDRMS  -0.1040    0.0465 -2.2361  0.0253
          NUNITS   0.0234    0.0134  1.7432  0.0813
           EJUNK  -0.5695    0.3093 -1.8415  0.0656
            ESFD  -0.3985    0.1853 -2.1513  0.0315
          ETRANS  -0.1742    0.1410 -1.2356  0.2166
           EABAN  -0.6480    0.2510 -2.5822  0.0098
            INTW  -0.0567    0.0275 -2.0606  0.0393
          FRSTHO  -0.3161    0.0888 -3.5608  0.0004
        STATE_CO  -0.0415    0.1061 -0.3908  0.6959
        STATE_CT   0.8530    0.1275  6.6922  0.0000
        STATE_GA   0.2964    0.1367  2.1676  0.0302
        STATE_IL   0.4020    0.4308  0.9331  0.3508
        STATE_IN   0.7344    0.1791  4.1011  0.0000
        STATE_LA   0.7326    0.2326  3.1494  0.0016
        STATE_MO   0.8763    0.1818  4.8199  0.0000
        STATE_OH   0.7728    0.1790  4.3168  0.0000
        STATE_OK   1.0786    0.2655  4.0626  0.0000
        STATE_PA   0.7274    0.2256  3.2237  0.0013
        STATE_TX   0.6446    0.2659  2.4241  0.0153
        STATE_WA   0.2529    0.1120  2.2579  0.0240
     METRO_urban  -0.0364    0.0961 -0.3785  0.7051
    HHGRAD_Assoc  -0.6786    0.1142 -5.9400  0.0000
     HHGRAD_Grad   0.0146    0.0994  0.1471  0.8830
  HHGRAD_HS_Grad  -0.5142    0.0840 -6.1181  0.0000
    HHGRAD_No_HS  -0.8903    0.1717 -5.1846  0.0000
       HOWH_good  -0.1540    0.1552 -0.9925  0.3209
       HOWN_good   0.4110    0.1202  3.4188  0.0006
DWNPAY_prev_home   0.5943    0.0853  6.9678  0.0000

(Dispersion parameter for binomial family taken to be 1.0000)
    Null deviance: 5908.5931 on 4680 degrees of freedom
Residual deviance: 5328.8668 on 4680 degrees of freedom
AIC: 5390.8668</code></pre>
</div>
</div>
<div class="cell" data-outputid="7ae28614-a53b-4ac1-8902-bd4abf4bfeb3">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute confusion matrix</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>dtest_5 <span class="op">=</span> dtest_5.withColumn(<span class="st">"predicted_class"</span>, when(col(<span class="st">"prediction"</span>) <span class="op">&gt;</span> <span class="fl">.02</span>, <span class="dv">1</span>).otherwise(<span class="dv">0</span>))</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>conf_matrix <span class="op">=</span> dtest_5.groupBy(<span class="st">"GT20DOWN"</span>, <span class="st">"predicted_class"</span>).count().orderBy(<span class="st">"GT20DOWN"</span>, <span class="st">"predicted_class"</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>TP <span class="op">=</span> dtest_5.<span class="bu">filter</span>((col(<span class="st">"GT20DOWN"</span>) <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (col(<span class="st">"predicted_class"</span>) <span class="op">==</span> <span class="dv">1</span>)).count()</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>FP <span class="op">=</span> dtest_5.<span class="bu">filter</span>((col(<span class="st">"GT20DOWN"</span>) <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (col(<span class="st">"predicted_class"</span>) <span class="op">==</span> <span class="dv">1</span>)).count()</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>FN <span class="op">=</span> dtest_5.<span class="bu">filter</span>((col(<span class="st">"GT20DOWN"</span>) <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (col(<span class="st">"predicted_class"</span>) <span class="op">==</span> <span class="dv">0</span>)).count()</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>TN <span class="op">=</span> dtest_5.<span class="bu">filter</span>((col(<span class="st">"GT20DOWN"</span>) <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (col(<span class="st">"predicted_class"</span>) <span class="op">==</span> <span class="dv">0</span>)).count()</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>accuracy <span class="op">=</span> (TP <span class="op">+</span> TN) <span class="op">/</span> (TP <span class="op">+</span> FP <span class="op">+</span> FN <span class="op">+</span> TN)</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>precision <span class="op">=</span> TP <span class="op">/</span> (TP <span class="op">+</span> FP)</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>recall <span class="op">=</span> TP <span class="op">/</span> (TP <span class="op">+</span> FN)</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>specificity <span class="op">=</span> TN <span class="op">/</span> (TN <span class="op">+</span> FP)</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>average_rate <span class="op">=</span> (TP <span class="op">+</span> FN) <span class="op">/</span> (TP <span class="op">+</span> TN <span class="op">+</span> FP <span class="op">+</span> FN)  <span class="co"># Proportion of actual at-risk babies</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>enrichment <span class="op">=</span> precision <span class="op">/</span> average_rate</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Print formatted confusion matrix with labels</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st"> Confusion Matrix:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"                     Predicted"</span>)</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"            |  Negative  |  Positive  "</span>)</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"------------+------------+------------"</span>)</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Actual Neg. |    </span><span class="sc">{</span>TN<span class="sc">:5}</span><span class="ss">   |    </span><span class="sc">{</span>FP<span class="sc">:5}</span><span class="ss">  |"</span>)</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"------------+------------+------------"</span>)</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Actual Pos. |    </span><span class="sc">{</span>FN<span class="sc">:5}</span><span class="ss">   |    </span><span class="sc">{</span>TP<span class="sc">:5}</span><span class="ss">  |"</span>)</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"------------+------------+------------"</span>)</span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Accuracy:  </span><span class="sc">{</span>accuracy<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Precision: </span><span class="sc">{</span>precision<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Recall (Sensitivity): </span><span class="sc">{</span>recall<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Specificity:  </span><span class="sc">{</span>specificity<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average Rate: </span><span class="sc">{</span>average_rate<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Enrichment:   </span><span class="sc">{</span>enrichment<span class="sc">:.4f}</span><span class="ss"> (Relative Precision)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Confusion Matrix:

                     Predicted
            |  Negative  |  Positive  
------------+------------+------------
Actual Neg. |        0   |      960  |
------------+------------+------------
Actual Pos. |        0   |     2160  |
------------+------------+------------
Accuracy:  0.6923
Precision: 0.6923
Recall (Sensitivity): 1.0000
Specificity:  0.0000
Average Rate: 0.6923
Enrichment:   1.0000 (Relative Precision)</code></pre>
</div>
</div>
</section>
<section id="auc-and-roc" class="level4">
<h4 class="anchored" data-anchor-id="auc-and-roc">AUC and ROC</h4>
<div class="cell" data-outputid="bca21adf-4755-49cd-9c97-76f2e2a9270c">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use probability of the positive class (y=1)</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> BinaryClassificationEvaluator(labelCol<span class="op">=</span><span class="st">"GT20DOWN"</span>, rawPredictionCol<span class="op">=</span><span class="st">"prediction"</span>, metricName<span class="op">=</span><span class="st">"areaUnderROC"</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate AUC</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>auc <span class="op">=</span> evaluator.evaluate(dtest_5)</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"AUC: </span><span class="sc">{</span>auc<span class="sc">:.4f}</span><span class="ss">"</span>)  <span class="co"># Higher is better (closer to 1)</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to Pandas</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>pdf <span class="op">=</span> dtest_5.select(<span class="st">"prediction"</span>, <span class="st">"GT20DOWN"</span>).toPandas()</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute ROC curve</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>fpr, tpr, _ <span class="op">=</span> roc_curve(pdf[<span class="st">"GT20DOWN"</span>], pdf[<span class="st">"prediction"</span>])</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot ROC curve</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">6</span>))</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>plt.plot(fpr, tpr, label<span class="op">=</span><span class="ss">f"ROC Curve (AUC = </span><span class="sc">{</span>auc<span class="sc">:.4f}</span><span class="ss">)"</span>)</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'k--'</span>, label<span class="op">=</span><span class="st">"Random Guess"</span>)</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"False Positive Rate"</span>)</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"True Positive Rate"</span>)</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"ROC Curve"</span>)</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AUC: 0.6741</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="hw4_pt_3_files/figure-html/cell-48-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="homes-worth-value-175k-1" class="level3">
<h3 class="anchored" data-anchor-id="homes-worth-value-175k-1">Homes worth VALUE &lt; 175k</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>dtrain, dtest <span class="op">=</span> less_than_175000.randomSplit([<span class="fl">0.6</span>, <span class="fl">0.4</span>], seed<span class="op">=</span><span class="dv">1234</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="94686d22-60e7-4b6e-9f6e-294fa21eee0d">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>dummy_cols_STATE, ref_category_STATE <span class="op">=</span> add_dummy_variables(<span class="st">'STATE'</span>, <span class="dv">0</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>dummy_cols_METRO, ref_category_METRO <span class="op">=</span> add_dummy_variables(<span class="st">'METRO'</span>, <span class="dv">0</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>dummy_cols_HHGRAD, ref_category_HHGRAD <span class="op">=</span> add_dummy_variables(<span class="st">'HHGRAD'</span>, <span class="dv">1</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>dummy_cols_HOWH, ref_category_HOWH <span class="op">=</span> add_dummy_variables(<span class="st">'HOWH'</span>, <span class="dv">0</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>dummy_cols_HOWN, ref_category_HOWN <span class="op">=</span> add_dummy_variables(<span class="st">'HOWN'</span>, <span class="dv">0</span>)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>dummy_cols_DWNPAY, ref_category_DWNPAY <span class="op">=</span> add_dummy_variables(<span class="st">'DWNPAY'</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reference category (dummy omitted): CA
Reference category (dummy omitted): rural
Reference category (dummy omitted): Bach
Reference category (dummy omitted): bad
Reference category (dummy omitted): bad
Reference category (dummy omitted): other</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>assembler_predictors <span class="op">=</span> (</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    conti_cols_2 <span class="op">+</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    dummy_cols</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>assembler_6 <span class="op">=</span> VectorAssembler(</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    inputCols <span class="op">=</span> assembler_predictors,</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    outputCol <span class="op">=</span> <span class="st">"predictors"</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>dtrain_6 <span class="op">=</span> assembler_6.transform(dtrain)</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>dtest_6  <span class="op">=</span> assembler_6.transform(dtest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># training the model</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>model_6 <span class="op">=</span> (</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    GeneralizedLinearRegression(featuresCol<span class="op">=</span><span class="st">"predictors"</span>,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>                                labelCol<span class="op">=</span><span class="st">"GT20DOWN"</span>,</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>                                family<span class="op">=</span><span class="st">"binomial"</span>,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>                                link<span class="op">=</span><span class="st">"logit"</span>)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    .fit(dtrain_6)</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>dtrain_6 <span class="op">=</span> model_6.transform(dtrain_6)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>dtest_6 <span class="op">=</span> model_6.transform(dtest_6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="d97fb76e-b01a-4fb8-d62d-6d02e5db13ce">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>model_6.summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>Coefficients:
         Feature Estimate Std Error T Value P Value
     (Intercept)   1.0004    0.3609  2.7724  0.0056
           ZINC2   0.0000    0.0000  2.4733  0.0134
           BATHS   0.2564    0.0641  4.0021  0.0001
          BEDRMS  -0.1801    0.0469 -3.8381  0.0001
          NUNITS   0.0288    0.0117  2.4521  0.0142
           EJUNK  -0.4302    0.2098 -2.0506  0.0403
            ESFD  -0.1264    0.1233 -1.0256  0.3051
          ETRANS  -0.0607    0.1006 -0.6037  0.5461
           EABAN  -0.2049    0.1320 -1.5520  0.1207
            INTW  -0.0681    0.0177 -3.8552  0.0001
          FRSTHO  -0.2598    0.0747 -3.4807  0.0005
        STATE_CO  -0.1942    0.3192 -0.6083  0.5430
        STATE_CT   0.5233    0.3094  1.6911  0.0908
        STATE_GA  -0.4573    0.2993 -1.5280  0.1265
        STATE_IL   0.2285    0.3448  0.6625  0.5076
        STATE_IN  -0.1152    0.2925 -0.3939  0.6936
        STATE_LA   0.1373    0.3037  0.4520  0.6513
        STATE_MO  -0.2127    0.3007 -0.7074  0.4793
        STATE_OH   0.3449    0.2978  1.1583  0.2468
        STATE_OK  -0.1493    0.2936 -0.5086  0.6110
        STATE_PA   0.0185    0.2978  0.0621  0.9505
        STATE_TX   0.0126    0.2965  0.0425  0.9661
        STATE_WA   0.2563    0.3452  0.7425  0.4578
     METRO_urban  -0.0106    0.0778 -0.1367  0.8913
    HHGRAD_Assoc  -0.5577    0.1074 -5.1936  0.0000
     HHGRAD_Grad   0.0209    0.1275  0.1640  0.8697
  HHGRAD_HS_Grad  -0.5503    0.0821 -6.7068  0.0000
    HHGRAD_No_HS  -0.7198    0.1241 -5.7995  0.0000
       HOWH_good   0.1855    0.1070  1.7341  0.0829
       HOWN_good  -0.0093    0.0888 -0.1051  0.9163
DWNPAY_prev_home   0.4973    0.0946  5.2586  0.0000

(Dispersion parameter for binomial family taken to be 1.0000)
    Null deviance: 6427.1456 on 4622 degrees of freedom
Residual deviance: 6060.5538 on 4622 degrees of freedom
AIC: 6122.5538</code></pre>
</div>
</div>
<div class="cell" data-outputid="74fdda0d-e1e8-4e44-f6a0-3632cedaf802">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute confusion matrix</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>dtest_6 <span class="op">=</span> dtest_6.withColumn(<span class="st">"predicted_class"</span>, when(col(<span class="st">"prediction"</span>) <span class="op">&gt;</span> <span class="fl">.02</span>, <span class="dv">1</span>).otherwise(<span class="dv">0</span>))</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>conf_matrix <span class="op">=</span> dtest_6.groupBy(<span class="st">"GT20DOWN"</span>, <span class="st">"predicted_class"</span>).count().orderBy(<span class="st">"GT20DOWN"</span>, <span class="st">"predicted_class"</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>TP <span class="op">=</span> dtest_6.<span class="bu">filter</span>((col(<span class="st">"GT20DOWN"</span>) <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (col(<span class="st">"predicted_class"</span>) <span class="op">==</span> <span class="dv">1</span>)).count()</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>FP <span class="op">=</span> dtest_6.<span class="bu">filter</span>((col(<span class="st">"GT20DOWN"</span>) <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (col(<span class="st">"predicted_class"</span>) <span class="op">==</span> <span class="dv">1</span>)).count()</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>FN <span class="op">=</span> dtest_6.<span class="bu">filter</span>((col(<span class="st">"GT20DOWN"</span>) <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (col(<span class="st">"predicted_class"</span>) <span class="op">==</span> <span class="dv">0</span>)).count()</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>TN <span class="op">=</span> dtest_6.<span class="bu">filter</span>((col(<span class="st">"GT20DOWN"</span>) <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (col(<span class="st">"predicted_class"</span>) <span class="op">==</span> <span class="dv">0</span>)).count()</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>accuracy <span class="op">=</span> (TP <span class="op">+</span> TN) <span class="op">/</span> (TP <span class="op">+</span> FP <span class="op">+</span> FN <span class="op">+</span> TN)</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>precision <span class="op">=</span> TP <span class="op">/</span> (TP <span class="op">+</span> FP)</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>recall <span class="op">=</span> TP <span class="op">/</span> (TP <span class="op">+</span> FN)</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>specificity <span class="op">=</span> TN <span class="op">/</span> (TN <span class="op">+</span> FP)</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>average_rate <span class="op">=</span> (TP <span class="op">+</span> FN) <span class="op">/</span> (TP <span class="op">+</span> TN <span class="op">+</span> FP <span class="op">+</span> FN)  <span class="co"># Proportion of actual at-risk babies</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>enrichment <span class="op">=</span> precision <span class="op">/</span> average_rate</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Print formatted confusion matrix with labels</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st"> Confusion Matrix:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"                     Predicted"</span>)</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"            |  Negative  |  Positive  "</span>)</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"------------+------------+------------"</span>)</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Actual Neg. |    </span><span class="sc">{</span>TN<span class="sc">:5}</span><span class="ss">   |    </span><span class="sc">{</span>FP<span class="sc">:5}</span><span class="ss">  |"</span>)</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"------------+------------+------------"</span>)</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Actual Pos. |    </span><span class="sc">{</span>FN<span class="sc">:5}</span><span class="ss">   |    </span><span class="sc">{</span>TP<span class="sc">:5}</span><span class="ss">  |"</span>)</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"------------+------------+------------"</span>)</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Accuracy:  </span><span class="sc">{</span>accuracy<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Precision: </span><span class="sc">{</span>precision<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Recall (Sensitivity): </span><span class="sc">{</span>recall<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Specificity:  </span><span class="sc">{</span>specificity<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average Rate: </span><span class="sc">{</span>average_rate<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Enrichment:   </span><span class="sc">{</span>enrichment<span class="sc">:.4f}</span><span class="ss"> (Relative Precision)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Confusion Matrix:

                     Predicted
            |  Negative  |  Positive  
------------+------------+------------
Actual Neg. |        0   |     1422  |
------------+------------+------------
Actual Pos. |        0   |     1659  |
------------+------------+------------
Accuracy:  0.5385
Precision: 0.5385
Recall (Sensitivity): 1.0000
Specificity:  0.0000
Average Rate: 0.5385
Enrichment:   1.0000 (Relative Precision)</code></pre>
</div>
</div>
<section id="auc-and-roc-1" class="level4">
<h4 class="anchored" data-anchor-id="auc-and-roc-1">AUC and ROC</h4>
<div class="cell" data-outputid="79324d51-2c81-49ac-c71f-df7a5e5ce28f">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use probability of the positive class (y=1)</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> BinaryClassificationEvaluator(labelCol<span class="op">=</span><span class="st">"GT20DOWN"</span>, rawPredictionCol<span class="op">=</span><span class="st">"prediction"</span>, metricName<span class="op">=</span><span class="st">"areaUnderROC"</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate AUC</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>auc <span class="op">=</span> evaluator.evaluate(dtest_6)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"AUC: </span><span class="sc">{</span>auc<span class="sc">:.4f}</span><span class="ss">"</span>)  <span class="co"># Higher is better (closer to 1)</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to Pandas</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>pdf <span class="op">=</span> dtest_6.select(<span class="st">"prediction"</span>, <span class="st">"GT20DOWN"</span>).toPandas()</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute ROC curve</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>fpr, tpr, _ <span class="op">=</span> roc_curve(pdf[<span class="st">"GT20DOWN"</span>], pdf[<span class="st">"prediction"</span>])</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot ROC curve</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">6</span>))</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>plt.plot(fpr, tpr, label<span class="op">=</span><span class="ss">f"ROC Curve (AUC = </span><span class="sc">{</span>auc<span class="sc">:.4f}</span><span class="ss">)"</span>)</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'k--'</span>, label<span class="op">=</span><span class="st">"Random Guess"</span>)</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"False Positive Rate"</span>)</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"True Positive Rate"</span>)</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"ROC Curve"</span>)</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AUC: 0.6519</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="hw4_pt_3_files/figure-html/cell-56-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="interpretation" class="level3">
<h3 class="anchored" data-anchor-id="interpretation">Interpretation</h3>
<p><strong>The logistic regression model for houses with a value of 175k or greater has a residual deviance of <span class="math inline">\(5328.8668\)</span>. The model for houses with a value of less than 175k has a residual deviance of <span class="math inline">\(6060.5538\)</span>. This shows that the model for houses with a value of 175k or greater fits the data better because it has a lower residual deviance. In other words, the predictors more accurately predict if the homebuyer makes a 20% down payment for houses with a value of 175k or greater.</strong></p>
<p><strong>The model for houses with a value of 175k or higher has an accuracy of <span class="math inline">\(0.6923\)</span>, whereas the model for houses with a value of less than 175k has an accuracy of <span class="math inline">\(0.5385\)</span>. Once again, the model for higher value houses makes more accurate predictions because of its higher accuracy.</strong></p>
<p><strong>The AUC of the model for houses with greater value is <span class="math inline">\(0.6741\)</span>. The AUC of the model for lower value houses is <span class="math inline">\(0.6519\)</span>. The AUC for the model with higher value houses is slightly closer to 1 than the model with lower value houses. This supports the previous two claims that the model with higher value houses more accurately predicts if the homebuyer makes a 20% down payment.</strong></p>


</section>
</section>

</main> <!-- /main -->
<script type="text/javascript" src="links.js"></script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">Powered with GitHub and Quarto<br>© Brennan, 2023</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>